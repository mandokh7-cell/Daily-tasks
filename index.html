<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily tasks</title>

  <!-- Favicon Light & Dark -->
  <link rel="icon" type="image/png" href="task48.png" media="(prefers-color-scheme: dark)">
  <link rel="icon" type="image/png" href="tasks48.png" media="(prefers-color-scheme: light)">
  
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Fonts: Cairo & Inter -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<!-- خط خاص بالآيات القرآنية -->
<link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">


<style>
  :root {
    /* الوان موقع الزين - الوضع النهاري (الافتراضي) */
    --bg: #f7f7f7;
    --text: #222;
    --accent: #0066ff; 
    --card-bg-solid: rgba(255, 255, 255, 0.95);
    --muted: #666;
    --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    --border-color: #eee;
    
    /* الوان خاصة بالتصميم الزجاجي */
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.3);
    --input-bg: rgba(255, 255, 255, 0.15);
    --item-bg: rgba(255, 255, 255, 0.1);

    /* الوان التحديات */
    --bronze: #cd7f32;
    --silver: #c0c0c0;
    --gold: #ffd700;
    --level-bg: rgba(0, 102, 255, 0.1);
  }

  /* (مُعدل) الوان موقع الزين - الوضع الليلي */
  body[data-theme="dark"] {
    --bg: #0d1117; 
    --text: #e2e8f0;
    --accent: #00aaff; 
    --card-bg-solid: rgba(20, 25, 30, 0.88);
    --muted: #a0aec0;
    --shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    --border-color: #333;

    /* الوان خاصة بالتصميم الزجاجي ليلاً */
    --glass-bg: rgba(20, 25, 30, 0.4);
    --glass-border: rgba(255, 255, 255, 0.2);
    --input-bg: rgba(0, 0, 0, 0.2);
    --item-bg: rgba(0, 0, 0, 0.15);
    --level-bg: rgba(0, 170, 255, 0.15);
  }
  
  /* (جديد) الثيم البحري: "محيط" */
  body[data-theme="ocean"] {
    --bg: #F0F8FF; /* أزرق سماوي فاتح */
    --text: #00334E; /* أزرق غامق (كحلي) */
    --accent: #00A896; /* تركواز */
    --card-bg-solid: rgba(255, 255, 255, 0.95); /* صلب */
    --muted: #005E7C;
    --shadow: 0 8px 20px rgba(0, 168, 150, 0.15);
    --border-color: #D1E9FF;

    /* الوان خاصة بالتصميم الزجاجي */
    --glass-bg: rgba(240, 248, 255, 0.4); /* استخدام لون الخلفية مع شفافية */
    --glass-border: rgba(0, 51, 78, 0.2); /* استخدام لون النص مع شفافية */
    --input-bg: rgba(255, 255, 255, 0.3);
    --item-bg: rgba(255, 255, 255, 0.2);
    --level-bg: rgba(0, 168, 150, 0.1);
  }


  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html {
    scroll-behavior: smooth;
  }
  
  body {
    font-family: 'Cairo', 'Inter', sans-serif; 
    background: var(--bg); 
    color: var(--text); 
    min-height: 100vh;
    padding: 20px 20px 100px 20px; /* تقليل الحشو السفلي */
    transition: background 0.4s, color 0.4s;
  }

  /* Animated background blobs */
  .background-blobs {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.5;
  }
  .blob1 {
    width: 400px;
    height: 400px;
    background: var(--accent);
    top: -100px;
    left: -100px;
    animation: moveBlob1 15s infinite alternate ease-in-out;
  }
  .blob2 {
    width: 300px;
    height: 300px;
    background: #26d0ce;
    bottom: -50px;
    right: -50px;
    animation: moveBlob2 12s infinite alternate ease-in-out;
  }
  @keyframes moveBlob1 {
    from { transform: translate(0, 0) scale(1); }
    to { transform: translate(200px, 100px) scale(1.2); }
  }
  @keyframes moveBlob2 {
    from { transform: translate(0, 0) scale(1); }
    to { transform: translate(-150px, -100px) scale(0.8); }
  }
  
  .top-controls {
    width: 100%;
    display: flex;
    justify-content: space-between;
    z-index: 100;
  }
  
  .control-btn {
    font-size: 20px; 
    cursor: pointer; 
    color: var(--text); 
    transition: color .4s, background .4s, transform 0.3s; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    width: 44px; 
    height: 44px; 
    border-radius: 12px; 
    background: var(--card-bg-solid); 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 1px solid var(--border-color);
  }
  .control-btn:hover {
      transform: translateY(-2px);
  }
  .control-btn[aria-pressed="true"] { 
      color: var(--accent); 
  }
  
  /* حاوية التطبيق الرئيسية */
  .app-container {
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 20px; 
    z-index: 2;
    margin-bottom: 100px; /* تقليل الهامش السفلي */
  }
  
  /* ستايل صفحات التطبيق (لإخفاء وإظهار الأقسام) */
  .app-page {
    display: none; 
    flex-direction: column;
    gap: 20px;
    animation: fadeIn 0.5s ease;
  }
  .app-page.active {
    display: flex; 
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* ستايل زجاجي مشترك (لإعادة الاستخدام) */
  .glass-box {
    position: relative;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 20px;
    box-shadow: var(--shadow);
    padding: 25px;
    width: 100%;
    border: 1px solid var(--glass-border);
    transition: background 0.4s, border-color 0.4s;
  }
  
  /* --- 1. ستايلات قسم المهام --- */
  
  .motivation-widget {
    padding: 20px 25px;
    text-align: center;
    font-size: 1rem;
    font-weight: 700;
    color: var(--text);
    font-style: italic;
    line-height: 1.6;
  }
  .motivation-widget::before {
    content: " رسالة الزين لك اليوم :";
    display: block;
    font-size: 0.9rem;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 8px;
  }
  
  .datetime-widget {
    padding: 20px 25px;
    text-align: center;
  }
  #time-display {
    font-size: 2.5rem;
    font-weight: 900;
    color: var(--accent);
    font-family: 'Inter', sans-serif;
    letter-spacing: 1px;
    direction: ltr; 
  }
  #date-display {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text);
    opacity: 0.9;
    margin-top: 5px;
  }
  /* (مُزال) تم إزالة التاريخ الهجري */
  
  .todo-box {
    padding: 30px;
  }
  .date-nav {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .date-nav-btn {
    flex: 1;
    background: var(--card-bg-solid);
    color: var(--muted);
    border: 1px solid var(--border-color);
    padding: 10px;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  #nav-picker {
    flex: 0 0 auto;
    width: 44px;
    padding: 0;
    font-size: 16px;
  }
  .date-nav-btn:hover { background: var(--border-color); }
  .date-nav-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    box-shadow: 0 4px 10px var(--accent);
  }
  body[data-theme="ocean"] .date-nav-btn.active {
      box-shadow: 0 4px 10px rgba(0, 168, 150, 0.4);
  }
  body[data-theme="dark"] .date-nav-btn.active {
      box-shadow: 0 4px 10px rgba(0, 170, 255, 0.4);
  }


  #task-list-title {
    font-size: 28px;
    margin-bottom: 20px;
    font-weight: 900;
    color: var(--accent);
    text-align: center;
  }
  #task-form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  #task-input {
    flex: 1;
    padding: 14px 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    outline: none;
    font-family: 'Cairo', 'Inter', sans-serif;
    background: var(--input-bg);
    color: var(--text);
    font-size: 16px;
    transition: all 0.3s ease;
  }
  #task-input:focus {
    background: var(--input-bg);
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent);
  }
  #task-input:disabled {
    background: rgba(0, 0, 0, 0.05);
    cursor: not-allowed;
  }
  #task-form button {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 0 25px;
    font-size: 18px;
    font-weight: 700;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px var(--accent);
  }
  #task-form button:hover {
    background: var(--accent);
    opacity: 0.8;
    transform: translateY(-2px);
  }
  #task-form button:disabled {
    background: var(--muted);
    cursor: not-allowed;
    box-shadow: none;
  }
  #task-list {
    list-style: none;
    padding: 0;
    margin: 0;
    min-height: 100px;
    max-height: 30vh;
    overflow-y: auto;
  }
  .task-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--item-bg);
    border: 1px solid var(--border-color);
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    word-break: break-word;
  }
  .task-item.completed {
    background: rgba(0,0,0,0.05);
    border-color: transparent;
  }
  .task-content {
    display: flex;
    align-items: center;
    flex: 1;
    cursor: pointer;
    overflow: hidden; 
    padding-left: 5px;
  }
  .task-checkbox {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
    flex-shrink: 0;
    margin-left: 10px;
  }
  .task-checkbox:checked {
    background: var(--accent);
    border-color: var(--accent);
  }
  .task-checkbox:checked::before {
    content: '\f00c';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    color: #fff;
    font-size: 12px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  .task-content span {
    flex: 1;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .task-item.completed .task-content span {
    text-decoration: line-through;
    opacity: 0.6;
    font-style: italic;
  }
  .delete-btn {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 16px;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    line-height: 20px;
    transition: color 0.3s, background 0.3s;
    flex-shrink: 0;
  }
  .delete-btn:hover {
    color: #d9534f;
    background: rgba(217, 83, 79, 0.1);
  }
  .clear-btn {
    width: 100%;
    background: var(--card-bg-solid);
    color: var(--muted);
    border: 1px solid var(--border-color);
    padding: 10px;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
    margin-top: 20px;
  }
  .clear-btn:hover {
    background: #d9534f;
    color: #fff;
    border-color: #d9534f;
  }

  /* --- (جديد) ستايلات قسم الملاحظات الاحترافي --- */
  .notes-box {
    padding: 25px 30px;
  }
  .notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .notes-header h3 {
    text-align: right;
    font-weight: 900;
    color: var(--accent);
    font-size: 1.8rem;
    margin: 0;
  }
  .add-note-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .add-note-btn:hover {
    opacity: 0.8;
    transform: scale(1.1);
  }
  
  #notes-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 40vh;
    overflow-y: auto;
  }
  .note-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    padding: 12px 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s;
  }
  .note-list-item:hover {
    background: var(--item-bg);
  }
  .note-list-item:last-child {
    border-bottom: none;
  }
  .note-item-details {
    overflow: hidden; /* لمنع النص الطويل من الخروج */
  }
  .note-item-title {
    font-weight: 700;
    font-size: 1rem;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .note-item-date {
    font-weight: 500;
    font-size: 0.8rem;
    color: var(--muted);
  }
  .note-item-arrow {
    font-size: 0.9rem;
    color: var(--muted);
    flex-shrink: 0;
  }
  .no-notes {
    text-align: center;
    color: var(--muted);
    padding: 20px;
    font-size: 0.9rem;
    font-weight: 700;
  }
  
  /* ستايلات مودال الملاحظات */
  #notes-modal-content #note-content-input {
    width: 100%;
    min-height: 200px;
    padding: 14px 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    outline: none;
    font-family: 'Cairo', 'Inter', sans-serif;
    background: var(--input-bg);
    color: var(--text);
    font-size: 16px;
    transition: all 0.3s ease;
    resize: vertical;
  }
  #notes-modal-content #note-content-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent);
  }
  .note-timestamp {
    font-size: 0.85rem;
    color: var(--muted);
    text-align: center;
    margin-top: 15px;
    height: 1.2em;
    direction: ltr;
  }
  #notes-modal-content h2 {
    text-align: center;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 25px;
    font-size: 1.8rem;
  }


  /* --- ستايلات مؤقت التركيز --- */
  .timer-box {
    /* .glass-box */
  }
  .timer-box h3, .tasbeeh-box h3 {
    text-align: center;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 20px;
    font-size: 1.8rem;
  }
  .timer-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .timer-tab-btn {
    flex: 1;
    background: var(--card-bg-solid);
    color: var(--muted);
    border: 1px solid var(--border-color);
    padding: 10px;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .timer-tab-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .timer-display {
    font-size: 3.5rem;
    font-family: 'Inter', sans-serif;
    direction: ltr;
    text-align: center;
    color: var(--text);
    font-weight: 900;
    margin-bottom: 20px;
  }
  .timer-inputs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .timer-inputs input {
    flex: 1;
    padding: 14px 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    outline: none;
    font-family: 'Cairo', 'Inter', sans-serif;
    background: var(--input-bg);
    color: var(--text);
    font-size: 16px;
    transition: all 0.3s ease;
    text-align: center;
    -moz-appearance: textfield; /* Firefox */
  }
  .timer-inputs input::-webkit-outer-spin-button,
  .timer-inputs input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .timer-inputs input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent);
  }
  .timer-controls {
    display: flex;
    gap: 10px;
  }
  .timer-control-btn {
    flex: 1;
    background: var(--card-bg-solid);
    color: var(--text);
    border: 1px solid var(--border-color);
    padding: 12px;
    font-size: 1rem;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
  }
  .timer-control-btn.accent {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  
  /* ستايل المودال (مشترك للتقويم والإعدادات) */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    animation: fadeInModal 0.3s ease;
  }
  @keyframes fadeInModal {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .glass-modal-style {
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--glass-border);
    padding: 25px;
    width: 100%;
    max-width: 380px;
    color: var(--text);
    transition: background 0.4s, border-color 0.4s, color 0.4s;
    position: relative;
    max-height: 90vh; /* 90% من ارتفاع الشاشة */
    overflow-y: auto; /* إضافة سكرول داخلي عند الحاجة */
    animation: zoomInModal 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes zoomInModal {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  .modal-close-btn {
    position: absolute;
    top: 15px;
    left: 15px; 
    background: var(--item-bg);
    border: 1px solid var(--border-color);
    color: var(--muted);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    line-height: 30px;
    text-align: center;
    transition: all 0.3s;
  }
  .modal-close-btn:hover {
    background: var(--border-color);
    color: var(--text);
  }
  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  /* ستايلات مودال التقويم */
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .calendar-header button {
    background: none;
    border: none;
    color: var(--text);
    font-size: 20px;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 8px;
    transition: background 0.3s;
  }
  .calendar-header button:hover { background: var(--item-bg); }
  #calendar-month-year {
    font-size: 1.2rem;
    font-weight: 700;
  }
  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
  }
  .calendar-days div {
    text-align: center;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--muted);
  }
  .calendar-dates {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  .date-cell {
    background: var(--item-bg);
    border: 1px solid var(--border-color);
    color: var(--text);
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    border-radius: 8px;
    padding: 10px 5px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .date-cell.empty {
    background: none;
    border: 1px solid transparent;
    cursor: default;
    opacity: 0.3;
  }
  .date-cell:not(.empty):hover {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .date-cell.today {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent);
  }
  .date-cell.selected {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }

  /* --- 2. ستايلات قسم القرآن --- */
  
  #quran-bookmark-widget {
    padding: 20px 25px;
    text-align: right;
    font-size: 1rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1.6;
    cursor: pointer;
  }
  #quran-bookmark-widget::before {
    content: "علامة الختمة:";
    display: block;
    font-size: 0.9rem;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 8px;
  }
  #quran-bookmark-widget small {
    display: block;
    opacity: 0.7;
    font-size: 0.85rem;
  }
  
  .custom-select-wrapper {
    position: relative;
    margin-bottom: 20px;
  }
  .custom-select {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text);
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .custom-select:focus, .custom-select.open {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent);
    outline: none;
  }
  .custom-select i {
    color: var(--muted);
    transition: transform 0.3s ease;
  }
  .custom-select.open i {
    transform: rotate(180deg);
  }
  .custom-select-options {
    display: none;
    position: absolute;
    top: 110%;
    left: 0;
    right: 0;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    box-shadow: var(--shadow);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1001;
    padding: 5px;
  }
  .custom-select-options.open {
    display: block;
  }
  .custom-option {
    padding: 12px 20px;
    cursor: pointer;
    transition: background 0.2s;
    font-weight: 700;
    border-radius: 8px;
  }
  .custom-option:hover {
    background: var(--item-bg);
  }
  .custom-option.selected {
    background: var(--accent);
    color: #fff;
  }

  
  #quran-content {
    background: var(--item-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 20px;
    min-height: 200px;
    max-height: 60vh;
    overflow-y: auto;
    font-family: 'Amiri Quran', 'Cairo', serif;
    font-size: 1.5rem; 
    line-height: 2.5; 
    color: var(--text);
  }
  
  #quran-content.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    color: var(--muted);
  }
  
  .bismillah {
    text-align: center;
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 20px;
    color: var(--accent);
  }
  
  .verse { display: inline; }
  
  .verse-number {
    font-family: 'Inter', sans-serif;
    font-size: 0.9rem;
    font-weight: 900;
    color: var(--accent);
    display: inline-block;
    width: 28px;
    height: 28px;
    line-height: 28px;
    text-align: center;
    border: 1.5px solid var(--accent);
    border-radius: 50%;
    margin-right: 8px;
    margin-left: 8px;
    transition: all 0.3s ease;
    cursor: pointer; 
    user-select: none; 
  }

  #bookmarked-verse {
    background: var(--accent);
    color: #fff;
  }
  
  /* (جديد) ستايل مشغل الصوت */
  #quran-audio-player {
    width: 100%;
    margin-top: 20px;
  }

  /* --- 3. ستايلات قسم المسبحة (الوضع الحر) --- */
  
  .tasbeeh-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }
  
  #dhikr-text {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    padding: 15px 25px;
    background: var(--item-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    width: 100%;
    text-align: center;
  }
  
  .tasbeeh-counter-display {
    display: flex;
    align-items: center; 
    justify-content: center;
    gap: 10px;
    line-height: 1;
    margin: 10px 0;
  }

  #tasbeeh-count-current {
    font-size: 4.5rem; 
    font-weight: 900;
    font-family: 'Inter', sans-serif;
    color: var(--accent);
    text-align: center;
    transition: color 0.3s ease;
  }

  /* الهدف مخفي في هذا الوضع */
  #tasbeeh-count-target {
    display: none;
  }
  
  #tasbeeh-tap-btn {
    width: 100%; 
    height: auto; 
    padding: 40px 20px; 
    border-radius: 20px; 
    background: var(--card-bg-solid);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: all 0.15s ease-out;
    display: flex;
    flex-direction: column; 
    align-items: center;
    justify-content: center;
    gap: 10px; 
    font-size: 2.5rem; 
    color: var(--accent);
  }
  #tasbeeh-tap-btn span { 
    font-size: 1rem;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    color: var(--muted);
  }
  
  #tasbeeh-tap-btn:active {
    transform: scale(0.98); 
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    background: var(--item-bg);
  }
  
  .tasbeeh-controls {
    display: flex;
    gap: 10px;
    width: 100%;
  }
  
  .tasbeeh-btn {
    flex: 1;
    background: var(--card-bg-solid);
    color: var(--text);
    border: 1px solid var(--border-color);
    padding: 12px;
    font-size: 1rem;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
  }
  .tasbeeh-btn:hover {
    background: var(--item-bg);
  }
  .tasbeeh-btn.accent {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  
  #tasbeeh-total-count {
    font-size: 1rem;
    font-weight: 700;
    color: var(--muted);
    background: var(--input-bg);
    padding: 10px 15px;
    border-radius: 10px;
    margin-top: 10px;
  }

  /* --- (جديد) ستايلات قسم الأذكار --- */

  .adhkar-box {
    padding: 0; /* إزالة الحشو الداخلي للـ glass-box */
  }

  .adhkar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    cursor: pointer;
    transition: background 0.3s;
  }
  .adhkar-header:hover {
    background: var(--item-bg);
  }

  .adhkar-header h4 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .adhkar-header .toggle-icon {
    font-size: 1.2rem;
    color: var(--muted);
    transition: transform 0.3s ease;
  }

  /* تدوير السهم عند الفتح */
  .adhkar-header.active .toggle-icon {
    transform: rotate(180deg);
  }

  .adhkar-content {
    display: none; /* مخفي افتراضياً */
    padding: 0 25px 25px 25px;
    max-height: 40vh;
    overflow-y: auto;
    border-top: 1px solid var(--glass-border);
    animation: fadeIn 0.5s ease;
  }

  .adhkar-content.active {
    display: block; /* يظهر عند الضغط */
  }
  
  .adhkar-item {
    padding: 15px 0;
    border-bottom: 1px dashed var(--border-color);
  }
  .adhkar-item:last-child {
    border-bottom: none;
  }

  .adhkar-item p.dhikr-text {
    font-family: 'Amiri Quran', 'Cairo', serif;
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 2;
    color: var(--text);
  }

  .adhkar-item small.dhikr-count {
    display: block;
    margin-top: 10px;
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--accent);
  }


  /* --- 4. ستايلات قسم مواقيت الصلاة --- */
  
  #next-prayer-widget {
    text-align: center;
    padding: 15px;
    background: var(--input-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
  }
  #next-prayer-widget.loading {
    color: var(--muted);
    font-weight: 700;
  }
  #next-prayer-label {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--muted);
    display: block;
    margin-bottom: 5px;
  }
  #next-prayer-countdown {
    font-size: 1.8rem;
    font-weight: 900;
    color: var(--accent);
    font-family: 'Inter', sans-serif;
    direction: ltr;
  }
  
  #prayer-times-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .prayer-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--item-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    transition: all 0.3s ease;
  }
  .prayer-item-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
  }
  .prayer-item-time {
    font-size: 1.1rem;
    font-weight: 900;
    font-family: 'Inter', sans-serif;
    color: var(--accent);
    direction: ltr;
  }
  
  .prayer-item.highlight {
    background: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 4px 10px var(--accent);
  }
  .prayer-item.highlight .prayer-item-name,
  .prayer-item.highlight .prayer-item-time {
    color: #fff;
  }

  /* --- 5. ستايلات مودال الإعدادات --- */
  
  .settings-modal-content h2 {
    text-align: center;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 25px;
    font-size: 1.8rem;
  }
  .settings-section h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 5px;
  }
  .settings-section p {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 20px;
  }
  .settings-btn {
    width: 100%;
    background: var(--card-bg-solid);
    color: var(--text);
    border: 1px solid var(--border-color);
    padding: 12px;
    font-size: 1rem;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
  }
  .settings-btn.accent {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    box-shadow: 0 4px 10px var(--accent);
  }
  .settings-btn:hover {
    transform: translateY(-2px);
  }
  .settings-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .divider {
    display: flex;
    align-items: center;
    text-align: center;
    color: var(--muted);
    margin: 20px 0;
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--border-color);
  }
  .divider:not(:empty)::before { margin-left: .25em; } /* RTL */
  .divider:not(:empty)::after { margin-right: .25em; } /* RTL */

  .input-group {
    margin-bottom: 15px;
  }
  .input-group label {
    display: block;
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 5px;
  }
  .input-group input,
  .input-group textarea { /* (مُعدل) ليشمل الـ textarea */
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    outline: none;
    font-family: 'Cairo', 'Inter', sans-serif;
    background: var(--input-bg);
    color: var(--text);
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  .input-group input:focus,
  .input-group textarea:focus { /* (مُعدل) ليشمل الـ textarea */
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent);
  }
  .status-message {
    text-align: center;
    font-weight: 700;
    padding: 10px;
    border-radius: 8px;
    margin-top: 20px;
    font-size: 0.9rem;
  }
  .status-message.success {
    background: rgba(76, 175, 80, 0.1);
    color: #4CAF50;
  }
  body[data-theme="dark"] .status-message.success,
  body[data-theme="ocean"] .status-message.success {
    background: rgba(76, 175, 80, 0.2);
    color: #81C784;
  }
  .status-message.error {
    background: rgba(255, 99, 71, 0.1);
    color: #d9534f;
  }
  body[data-theme="dark"] .status-message.error,
  body[data-theme="ocean"] .status-message.error {
    background: rgba(255, 99, 71, 0.2);
    color: #FF8A80;
  }
  
  /* --- 6. ستايلات شريط التنقل السفلي --- */
  
  .bottom-nav {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--glass-border);
    
    display: flex;
    justify-content: space-around;
    padding: 10px;
    z-index: 100;
  }
  
  .nav-btn {
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'Cairo', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    border-radius: 12px;
    padding: 10px 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 0; 
  }
  
  .nav-btn i {
    font-size: 18px;
  }
  .nav-btn span {
    font-size: 0.8rem;
  }
  
  .nav-btn:hover {
    background: var(--item-bg);
  }
  
  .nav-btn.active {
    color: var(--accent);
    background: var(--input-bg);
  }
  
  /* --- 7. ستايلات تذييل حقوق النشر --- */
  .footer {
    position: relative; 
    z-index: 2;
    margin-top: 30px;
    font-size: 0.85rem;
    color: var(--muted);
    text-align: center;
    direction: ltr; 
    font-family: 'Inter', sans-serif; 
  }
  .footer a {
    color: var(--muted);
    text-decoration: none;
    transition: color 0.3s;
  }
  .footer a:hover {
    color: var(--accent);
  }

  /* --- 8. ستايلات التحريك عند الظهور --- */
  .reveal-on-scroll {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }
  .reveal-on-scroll.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* --- 9. ستايلات التحديات (إضافة جديدة) --- */
  .user-profile-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .user-info h3 {
    font-weight: 900;
    font-size: 1.4rem;
    color: var(--text);
  }
  .user-level-badge {
    background: var(--level-bg);
    color: var(--accent);
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 700;
    border: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: 0.3s;
  }
  .user-level-badge:hover {
    transform: scale(1.05);
    background: var(--item-bg);
  }
  .level-icon { color: var(--gold); }
  
  .points-progress-container {
    margin-bottom: 20px;
  }
  .points-bar-bg {
    width: 100%;
    height: 10px;
    background: var(--item-bg);
    border-radius: 5px;
    overflow: hidden;
    position: relative;
  }
  .points-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #42e695);
    width: 0%;
    transition: width 1s ease;
    border-radius: 5px;
  }
  .points-text {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
    margin-top: 5px;
  }

  .challenge-card {
    background: var(--item-bg);
    border: 1px solid var(--border-color);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    transition: transform 0.2s;
  }
  .challenge-card:hover {
    transform: translateY(-3px);
    border-color: var(--accent);
  }
  .challenge-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .challenge-title {
    font-weight: 700;
    font-size: 1.1rem;
  }
  .challenge-points-badge {
    background: rgba(255, 215, 0, 0.2);
    color: #b8860b;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
  }
  body[data-theme="dark"] .challenge-points-badge { color: #ffd700; }
  
  .challenge-progress {
    display: flex;
    gap: 5px;
    margin: 10px 0;
  }
  .day-dot {
    flex: 1;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    transition: background 0.3s;
  }
  .day-dot.active { background: var(--accent); }
  
  .challenge-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  .challenge-btn {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: none;
    font-family: 'Cairo', sans-serif;
    font-weight: 700;
    cursor: pointer;
    font-size: 0.9rem;
    transition: 0.3s;
  }
  .btn-check-in {
    background: var(--accent);
    color: #fff;
  }
  .btn-check-in:disabled {
    background: var(--muted);
    cursor: default;
    opacity: 0.6;
  }
  .btn-give-up {
    background: rgba(217, 83, 79, 0.1);
    color: #d9534f;
    border: 1px solid rgba(217, 83, 79, 0.2);
  }
  .btn-give-up:hover { background: rgba(217, 83, 79, 0.2); }

  /* مودال الاسم الشفاف */
  #name-modal {
    z-index: 2000; /* أعلى من كل شيء */
  }
  .name-input-style {
    width: 100%;
    padding: 15px;
    font-size: 1.2rem;
    text-align: center;
    border-radius: 15px;
    border: 2px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    outline: none;
    margin: 20px 0;
    font-family: 'Cairo', sans-serif;
  }
  .name-input-style:focus {
    border-color: var(--accent);
    background: var(--input-bg);
  }

  /* ستايل قائمة المستويات */
  .level-item {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 8px;
    background: var(--item-bg);
    border: 1px solid transparent;
  }
  .level-item.active-level {
    border-color: var(--accent);
    background: var(--level-bg);
  }
  .level-name { font-weight: bold; }
  .level-points { font-size: 0.9rem; color: var(--muted); }

</style>
</head>
<body>

<!-- Animated background blobs -->
<div class="background-blobs">
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
</div>

<!-- حاوية التطبيق الرئيسية -->
<div class="app-container">

  <!-- (محدّث) أزرار التحكم العلوية -->
  <div class="top-controls">
    <div id="themeToggle" class="control-btn" role="button" tabindex="0" aria-label="تبديل الوضع" aria-pressed="false">
      <i class="fas fa-moon" aria-hidden="true"></i>
    </div>
    <div id="settingsToggle" class="control-btn" role="button" tabindex="0" aria-label="الإعدادات">
      <i class="fas fa-gear" aria-hidden="true"></i>
    </div>
  </div>

  <!-- ======================= -->
  <!-- صفحة المهام        -->
  <!-- ======================= -->
  <div id="app-tasks" class="app-page active">
    
    <div id="motivation-widget" class="motivation-widget glass-box reveal-on-scroll">
      جارٍ تحميل رسالة اليوم...
    </div>
    
    <div class="datetime-widget glass-box reveal-on-scroll">
      <div id="time-display">12:00:00</div>
      <div id="date-display">الخميس، 30 أكتوبر 2025</div>
      <!-- (مُزال) تم حذف التاريخ الهجري -->
    </div>

    <div class="todo-box glass-box reveal-on-scroll">
      <div class="date-nav">
        <button class="date-nav-btn" id="nav-yesterday">الأمس</button>
        <button class="date-nav-btn" id="nav-today">اليوم</button>
        <button class="date-nav-btn" id="nav-tomorrow">الغد</button>
        <button class="date-nav-btn" id="nav-picker" aria-label="اختيار تاريخ">
          <i class="fas fa-calendar-alt"></i>
        </button>
      </div>
      
      <h1 id="task-list-title">مهام اليوم</h1>
      
      <form id="task-form">
        <input type="text" id="task-input" placeholder="أضف مهمة جديدة..." autocomplete="off">
        <button type="submit" id="task-submit-btn" aria-label="إضافة مهمة">
          <i class="fas fa-plus"></i>
        </button>
      </form>
      
      <ul id="task-list">
        <!-- المهام ستُضاف هنا -->
      </ul>
      
      <button id="clear-all-btn" class="clear-btn">
        <i class="fas fa-trash-alt"></i>
        <span id="clear-btn-text">مسح الكل</span>
      </button>
    </div>
    
    <!-- ======================= -->
    <!-- (مُعدل) قسم الملاحظات   -->
    <!-- ======================= -->
    <div class="notes-box glass-box reveal-on-scroll">
      <div class="notes-header">
        <h3><i class="fas fa-clipboard"></i> ملاحظاتي</h3>
        <button id="add-note-btn" class="add-note-btn" aria-label="إضافة ملاحظة جديدة">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <ul id="notes-list">
        <!-- <li class="no-notes">لا توجد ملاحظات..</li> -->
      </ul>
    </div>
    
    <div class="timer-box glass-box reveal-on-scroll">
      <h3><i class="fas fa-stopwatch"></i> مؤقت التركيز</h3>
      <div class="timer-tabs">
        <button class="timer-tab-btn active" id="timer-tab-timer" data-mode="timer">المؤقت</button>
        <button class="timer-tab-btn" id="timer-tab-stopwatch" data-mode="stopwatch">ساعة الإيقاف</button>
      </div>
      
      <div class="timer-display" id="timer-display">00:00:00</div>
      
      <div class="timer-inputs" id="timer-inputs">
        <input type="number" id="timer-minutes-input" placeholder="دقائق" min="0" max="999">
        <input type="number" id="timer-seconds-input" placeholder="ثواني" min="0" max="59">
      </div>
      
      <div class="timer-controls">
        <button id="timer-start-pause-btn" class="timer-control-btn accent">
          <i class="fas fa-play"></i><span id="timer-start-pause-text">ابدأ</span>
        </button>
        <button id="timer-reset-btn" class="timer-control-btn">
          <i class="fas fa-undo"></i> <span>إعادة تعيين</span>
        </button>
      </div>
    </div>
    
  </div>
  
  <!-- ======================= -->
  <!-- صفحة التحديات (جديد - تم نقله هنا) -->
  <!-- ======================= -->
  <div id="app-challenges" class="app-page">
    <div class="glass-box reveal-on-scroll">
      <div class="user-profile-header">
        <div class="user-info">
          <h3 id="challenge-user-name">مرحباً بك</h3>
          <div class="user-level-badge" id="show-levels-btn">
            <i class="fas fa-trophy level-icon"></i>
            <span id="user-level-text">مبتدئ</span>
          </div>
        </div>
        <div class="add-challenge-btn-container">
           <button id="open-challenge-modal-btn" class="add-note-btn" aria-label="إضافة تحدي">
            <i class="fas fa-plus"></i>
           </button>
        </div>
      </div>
      
      <div class="points-progress-container">
        <div class="points-bar-bg">
          <div id="points-progress-fill" class="points-bar-fill"></div>
        </div>
        <div class="points-text">
          <span id="user-points-display">0 نقطة</span>
          <span id="next-level-display">المستوى التالي: 500</span>
        </div>
      </div>

      <h2 style="font-size: 1.5rem; margin-bottom: 15px; color: var(--accent); font-weight: 900;">تحدياتك الحالية</h2>
      <div id="challenges-list-container">
        <!-- ستظهر التحديات هنا -->
        <p id="no-challenges-msg" style="text-align: center; color: var(--muted);">لا توجد تحديات نشطة. أضف تحدي جديد!</p>
      </div>
    </div>
  </div>

  <!-- ======================= -->
  <!-- صفحة القرآن       -->
  <!-- ======================= -->
  <div id="app-quran" class="app-page">
    
    <div id="quran-bookmark-widget" class="glass-box motivation-widget reveal-on-scroll" style="display: none; cursor: pointer; text-align: right;">
      <!-- سيتم ملؤه بواسطة JS -->
    </div>
    
    <div class="quran-box glass-box reveal-on-scroll">
      
      <div class="custom-select-wrapper">
        <div class="custom-select" id="custom-reciter-selector" role="combobox" aria-haspopup="listbox" aria-expanded="false" tabindex="0">
          <span id="custom-reciter-text">اختر القارئ</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="custom-select-options" id="custom-reciter-options" role="listbox">
          <!-- القراء ستُضاف هنا -->
        </div>
      </div>
      
      <div class="custom-select-wrapper">
        <div class="custom-select" id="custom-surah-selector" role="combobox" aria-haspopup="listbox" aria-expanded="false" tabindex="0">
          <span id="custom-surah-text">اختر السورة</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="custom-select-options" id="custom-surah-options" role="listbox">
          <!-- السور ستُضاف هنا -->
        </div>
      </div>
      
      <div id="quran-content" class="loading">
        الرجاء اختيار سورة لعرضها
      </div>
      
      <audio id="quran-audio-player" controls controlslist="noplaybackrate">
        عفواً، متصفحك لا يدعم مشغل الصوت.
      </audio>
    </div>
  </div>
  
  <!-- ======================= -->
  <!-- صفحة المسبحة -->
  <!-- ======================= -->
  <div id="app-tasbeeh" class="app-page">
    <!-- 1. صندوق المسبحة -->
    <div class="tasbeeh-box glass-box reveal-on-scroll">
      <h3><i class="fas fa-hand-pointer"></i> المسبحة الإلكترونية</h3>
      
      <div id="dhikr-text">سبحان الله</div>
      
      <div class="tasbeeh-counter-display">
        <span id="tasbeeh-count-current">0</span>
        <span id="tasbeeh-count-target"></span> 
      </div>
      
      <button id="tasbeeh-tap-btn" aria-label="زيادة العداد">
        <i class="fas fa-fingerprint"></i>
        <span>اضغط هنا</span>
      </button>
      
      <div class="tasbeeh-controls">
        <button id="tasbeeh-reset-btn" class="tasbeeh-btn">
          <i class="fas fa-undo"></i> <span>تصفير</span>
        </button>
        <button id="tasbeeh-change-btn" class="tasbeeh-btn accent">
          <i class="fas fa-sync-alt"></i> <span>الذكر التالي</span>
        </button>
      </div>
      
      <div id="tasbeeh-total-count">مجموع التسبيحات: 0</div>
    </div>
    
    <!-- 2. صندوق أذكار الصباح -->
    <div class="adhkar-box glass-box reveal-on-scroll">
      <div class="adhkar-header" id="adhkar-sabah-toggle" role="button" tabindex="0">
        <h4><i class="fas fa-sun"></i> أذكار الصباح</h4>
        <i class="fas fa-chevron-down toggle-icon"></i>
      </div>
      <div class="adhkar-content" id="adhkar-sabah-content">
        <div class="adhkar-item">
          <p class="dhikr-text">أَعُوذُ بِاللَّهِ مِنَ الشَّيْطَانِ الرَّجِيمِ ﴿اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ ...﴾</p>
          <small class="dhikr-count">آية الكرسي - مرة واحدة</small>
        </div>
        <div class="adhkar-item">
          <p class="dhikr-text">قُلْ هُوَ اللَّهُ أَحَدٌ... (سورة الإخلاص)</p>
          <p class="dhikr-text">قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ... (سورة الفلق)</p>
          <p class="dhikr-text">قُلْ أَعُوذُ بِرَبِّ النَّاسِ... (سورة الناس)</p>
          <small class="dhikr-count">المعوذات - ثلاث مرات</small>
        </div>
         <div class="adhkar-item">
          <p class="dhikr-text">أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ...</p>
          <small class="dhikr-count">مرة واحدة</small>
        </div>
        <div class="adhkar-item">
          <p class="dhikr-text">اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ وَإِلَيْكَ النُّشُورُ.</p>
          <small class="dhikr-count">مرة واحدة</small>
        </div>
        <div class="adhkar-item">
          <p class="dhikr-text">اللَّهُمَّ أَنْتَ رَبِِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ لَكَ بِذَنْبِي فَاغْفِرْ لِي، فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ.</p>
          <small class="dhikr-count">سيد الاستغفار - مرة واحدة</small>
        </div>
         <div class="adhkar-item">
          <p class="dhikr-text">بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ.</p>
          <small class="dhikr-count">ثلاث مرات</small>
        </div>
      </div>
    </div>
    
    <!-- 3. صندوق أذكار المساء -->
    <div class="adhkar-box glass-box reveal-on-scroll">
      <div class="adhkar-header" id="adhkar-masaa-toggle" role="button" tabindex="0">
        <h4><i class="fas fa-moon"></i> أذكار المساء</h4>
        <i class="fas fa-chevron-down toggle-icon"></i>
      </div>
      <div class="adhkar-content" id="adhkar-masaa-content">
        <div class="adhkar-item">
          <p class="dhikr-text">أَعُوذُ بِاللَّهِ مِنَ الشَّيْطَانِ الرَّجِيمِ ﴿اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ ...﴾</p>
          <small class="dhikr-count">آية الكرسي - مرة واحدة</small>
        </div>
        <div class="adhkar-item">
          <p class="dhikr-text">قُلْ هُوَ اللَّهُ أَحَدٌ... (سورة الإخلاص)</p>
          <p class="dhikr-text">قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ... (سورة الفلق)</p>
          <p class="dhikr-text">قُلْ أَعُوذُ بِرَبِّ النَّاسِ... (سورة الناس)</p>
          <small class="dhikr-count">المعوذات - ثلاث مرات</small>
        </div>
        <div class="adhkar-item">
          <p class="dhikr-text">أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ...</p>
          <small class="dhikr-count">مرة واحدة</small>
        </div>
        <div class="adhkar-item">
          <p class="dhikr-text">اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ وَإِلَيْكَ الْمَصِيرُ.</p>
          <small class="dhikr-count">مرة واحدة</small>
        </div>
        <div class="adhkar-item">
          <p class="dhikr-text">اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ...</p>
          <small class="dhikr-count">سيد الاستغفار - مرة واحدة</small>
        </div>
         <div class="adhkar-item">
          <p class="dhikr-text">بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ.</p>
          <small class="dhikr-count">ثلاث مرات</small>
        </div>
      </div>
    </div>

  </div>
  
  <!-- ======================= -->
  <!-- صفحة الصلاة      -->
  <!-- ======================= -->
  <div id="app-prayer" class="app-page">
    <div class="prayer-box glass-box reveal-on-scroll">
      <div id="next-prayer-widget" class="loading">
        <span id="next-prayer-label">مواقيت الصلاة</span>
        <div id="next-prayer-countdown">--:--:--</div>
      </div>
      <ul id="prayer-times-list">
        <!-- أوقات الصلاة ستُضاف هنا -->
      </ul>
    </div>
  </div>

  <!-- تذييل حقوق النشر -->
  <div class="footer">
       &copy; <a href="https://al-zain.netlify.app" target="_blank" rel="noopener noreferrer">2026 Mohamed Khald - جميع الحقوق محفوظة</a>
  </div>
</div>

<!-- ======================= -->
<!-- شريط التنقل السفلي (معدل الترتيب) -->
<!-- ======================= -->
<nav class="bottom-nav">
  <button id="nav-tasks-btn" class="nav-btn active" data-page="app-tasks">
    <i class="fas fa-check-square"></i>
    <span>المهام</span>
  </button>
  <!-- تم نقل التحديات هنا -->
  <button id="nav-challenges-btn" class="nav-btn" data-page="app-challenges">
    <i class="fas fa-trophy"></i>
    <span>التحديات</span>
  </button>
  <button id="nav-quran-btn" class="nav-btn" data-page="app-quran">
    <i class="fas fa-book-quran"></i>
    <span>القرآن</span>
  </button>
  <button id="nav-tasbeeh-btn" class="nav-btn" data-page="app-tasbeeh">
    <i class="fas fa-hand-pointer"></i>
    <span>المسبحة</span>
  </button>
  <button id="nav-prayer-btn" class="nav-btn" data-page="app-prayer">
    <i class="fas fa-mosque"></i>
    <span>الصلاة</span>
  </button>
</nav>

<!-- مودال التقويم (خاص بالمهام) -->
<div id="calendar-modal" class="modal-overlay">
  <div class="calendar-modal glass-modal-style">
    <button class="modal-close-btn" id="calendar-close-btn">&times;</button>
    <div class="calendar-header">
      <button id="calendar-prev-month"><i class="fas fa-chevron-right"></i></button>
      <span id="calendar-month-year">أكتوبر 2025</span>
      <button id="calendar-next-month"><i class="fas fa-chevron-left"></i></button>
    </div>
    <div class="calendar-days">
      <div>ح</div>
      <div>ن</div>
      <div>ث</div>
      <div>ر</div>
      <div>خ</div>
      <div>ج</div>
      <div>س</div>
    </div>
    <div class="calendar-dates" id="calendar-dates-grid">
      <!-- أيام التقويم ستُضاف هنا -->
    </div>
  </div>
</div>

<!-- ======================= -->
<!-- مودال الملاحظات -->
<!-- ======================= -->
<div id="notes-modal" class="modal-overlay">
  <div id="notes-modal-content" class="glass-modal-style" style="max-width: 500px;">
    <button class="modal-close-btn" id="notes-modal-close-btn">&times;</button>
    <h2 id="notes-modal-title">ملاحظة جديدة</h2>
    <div class="input-group">
      <label for="note-title-input">العنوان:</label>
      <input type="text" id="note-title-input" placeholder="عنوان الملاحظة">
    </div>
    <div class="input-group">
      <label for="note-content-input">المحتوى:</label>
      <textarea id="note-content-input" placeholder="اكتب ملاحظتك هنا"></textarea>
    </div>
    <div id="note-timestamp-status" class="note-timestamp"></div>
    <div class="modal-buttons">
      <button id="delete-note-btn" class="settings-btn" style="flex: 1; background: var(--item-bg); color: #d9534f; display: none;">
        <i class="fas fa-trash"></i> حذف
      </button>
      <button id="save-note-btn" class="settings-btn accent" style="flex: 2;">
        <i class="fas fa-save"></i> حفظ
      </button>
    </div>
  </div>
</div>


<!-- مودال الإعدادات -->
<div id="settings-modal" class="modal-overlay">
  <div class="settings-modal-content glass-modal-style">
    <button class="modal-close-btn" id="settings-close-btn">&times;</button>
    <h2><i class="fas fa-gear"></i> الإعدادات</h2>
    
    <div class="settings-section">
      <h3><i class="fas fa-map-marker-alt"></i> إعدادات الموقع</h3>
      <p>لتحديد مواقيت الصلاة بدقة.</p>
      
      <button id="auto-detect-btn" class="settings-btn accent">
        <i class="fas fa-location-crosshairs"></i> تحديد الموقع تلقائياً
      </button>
      
      <div class="divider"><span>أو</span></div>
      
      <div class="input-group">
        <label for="city-input">المدينة : </label>
        <input type="text" id="city-input" placeholder="مثال: الاسكندرية">
      </div>
      <div class="input-group">
        <label for="country-input">الدولة :</label>
        <input type="text" id="country-input" placeholder="مثال: مصر">
      </div>
      
      <button id="manual-save-btn" class="settings-btn">
        <i class="fas fa-save"></i> حفظ الإعدادات
      </button>
    </div>
    
    <div id="settings-status" class="status-message" style="display: none;"></div>
    
    <!-- قسم الإشعارات -->
    <div class="divider"></div>
    <div class="settings-section">
      <h3><i class="fas fa-bell"></i> إعدادات الإشعارات</h3>
      <p>تفعيل إشعارات المتصفح عند حلول وقت الصلاة.</p>
      <button id="enable-notifications-btn" class="settings-btn">
        <i class="fas fa-bell"></i> تفعيل الإشعارات
      </button>
    </div>

  </div>
</div>

<!-- مودال التأكيد (مشترك) -->
<div id="confirmation-modal" class="modal-overlay">
  <div class="confirmation-modal-content glass-modal-style" style="max-width: 340px; text-align: center;">
    <h3 id="confirmation-title" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 15px;">هل أنت متأكد؟</h3>
    <p id="confirmation-message" style="font-size: 1rem; line-height: 1.6; margin-bottom: 25px;">...</p>
    <div class="modal-buttons">
      <button id="confirm-btn" class="settings-btn accent" style="flex: 1;">
        <i class="fas fa-check"></i> نعم
      </button>
      <button id="cancel-btn" class="settings-btn" style="flex: 1; background: var(--item-bg);">
        <i class="fas fa-times"></i> إلغاء
      </button>
    </div>
  </div>
</div>

<!-- مودال إضافة تحدي -->
<div id="add-challenge-modal" class="modal-overlay">
  <div class="glass-modal-style" style="max-width: 380px;">
    <button class="modal-close-btn" id="close-challenge-modal">&times;</button>
    <h2 style="text-align: center; color: var(--accent); margin-bottom: 20px;">تحدي جديد 💪</h2>
    
    <div class="input-group">
      <label>عنوان التحدي</label>
      <input type="text" id="challenge-title-input" placeholder="مثال: صلاة الفجر">
    </div>
    
    <div class="input-group">
      <label>المدة (بالأيام)</label>
      <input type="number" id="challenge-duration-input" placeholder="7" value="7" min="1">
    </div>
    
    <div class="input-group">
      <label>النقاط عند الإتمام</label>
      <input type="number" id="challenge-points-input" placeholder="50" value="50" min="10">
    </div>
    
    <button id="save-challenge-btn" class="settings-btn accent">
      <i class="fas fa-plus-circle"></i> ابدأ التحدي
    </button>
  </div>
</div>

<!-- مودال إدخال الاسم (شفاف) -->
<div id="name-modal" class="modal-overlay">
  <div class="glass-modal-style" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); max-width: 350px; text-align: center;">
    <h2 style="color: var(--accent); margin-bottom: 10px; font-size: 1.8rem;">أهلاً بك في التحديات</h2>
    <p style="color: var(--text); font-weight: 500;">اكتب اسمك لتبدأ رحلة التحديات</p>
    
    <input type="text" id="user-name-input" class="name-input-style" placeholder="اسمك هنا">
    
    <button id="save-name-btn" class="settings-btn accent">
      انطلق <i class="fas fa-rocket"></i>
    </button>
  </div>
</div>

<!-- (جديد) مودال عرض المستويات -->
<div id="levels-modal" class="modal-overlay">
  <div class="glass-modal-style" style="max-width: 400px;">
    <button class="modal-close-btn" id="close-levels-modal">&times;</button>
    <h2 style="text-align: center; color: var(--accent); margin-bottom: 20px;">نظام المستويات</h2>
    <div id="levels-list-container">
      <!-- سيتم ملؤه بـ JS -->
    </div>
  </div>
</div>


<script type="module">
  
  // --- 1. إعدادات الثيمات ---
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = themeToggle.querySelector('i');
  const themes = ['light', 'dark', 'ocean'];
  const themeIcons = { 'light': 'fa-moon', 'dark': 'fa-water', 'ocean': 'fa-sun' };
  const themeLabels = { 'light': 'الوضع الليلي', 'dark': 'وضع المحيط', 'ocean': 'الوضع النهاري' };
  const THEME_STORAGE_KEY = 'alZainTheme_v1';
  
  function applyTheme(themeName) {
    document.body.dataset.theme = themeName;
    const nextIcon = themeIcons[themeName] || 'fa-moon';
    const nextLabel = themeLabels[themeName] || 'الوضع الليلي';
    themeIcon.className = `fas ${nextIcon}`;
    themeToggle.setAttribute('aria-label', nextLabel);
    themeToggle.setAttribute('aria-pressed', themeName !== 'light'); 
    localStorage.setItem(THEME_STORAGE_KEY, themeName);
  }

  themeToggle.addEventListener('click', () => {
    const currentTheme = document.body.dataset.theme || 'light';
    const currentIndex = themes.indexOf(currentTheme);
    const nextTheme = themes[(currentIndex + 1) % themes.length];
    applyTheme(nextTheme);
  });

  function loadTheme() {
    let savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    if (!savedTheme) {
        const oldTheme = localStorage.getItem('theme');
        if (oldTheme === 'dark') savedTheme = 'dark';
    }
    applyTheme(themes.includes(savedTheme) ? savedTheme : 'light');
  }


  // --- 2. إعدادات الساعة والتاريخ ---
  const timeEl = document.getElementById('time-display');
  const dateEl = document.getElementById('date-display');
  
  function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {
      hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    const dateString = now.toLocaleDateString('ar-EG', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
    timeEl.textContent = timeString;
    dateEl.textContent = dateString;
  }
  
  setInterval(updateTime, 1000);
  updateTime();

  // --- 3. منطق التحفيز اليومي ---
  const motivationWidget = document.getElementById('motivation-widget');
  const motivationMessages = [
  "الزين يتمنى لك يوم زين 💙",
  "اصحى وافتكر إنك لسه في السباق",
  "كل يوم جديد فرصة ما تتعوضش",
  "شد حيلك، اللي جاي أحسن",
  "إوعى تستهين بنفسك، انت قدها",
  "التعب ده مش بيروح على الفاضي",
  "كمل، حتى لو مفيش نفس",
  "انت أقوى مما تتخيل",
  "النجاح محتاج صبر مش استعجال",
  "خطوة صغيرة كل يوم تعمل فرق",
  "مافيش حلم بعيد على اللي بيجريله",
  "لو وقعت قوم، مفيش وقت للندم",
  "اشتغل على نفسك قبل أي حد",
  "الراحة بعد التعب طعمها مختلف",
  "إوعى تقف، اللي وراك مش مستنيك",
  "خليك ثابت، الدنيا بتمتحن",
  "كل مجهود محسوب حتى لو مش باين",
  "ثق في الطريق حتى لو طويل",
  "إوعى تفرط في حلمك",
  "انت مش قليل، الظروف بس صعبة",
  "اللي تعب امبارح بيكسب النهارده",
  "استحمل شوية، الفرج قريب",
  "مافيش نجاح من غير تضحية",
  "لو الدنيا قفلت افتحها بإرادتك",
  "انت بتكبر مع كل وجع",
  "إوعى تقارن، لكل واحد رحلته",
  "اشتغل كأن مفيش بكرة",
  "الكسل عدوك الأول",
  "قوم، مستقبلك مستنيك",
  "كل مرة تكمل فيها انت بتكسب",
  "ماتستناش حد يطبطب عليك",
  "خليك راجل في وقت الشدة",
  "النجاح مش صدفة، ده مجهود",
  "إوعى تخلي الخوف يسوقك",
  "اللي بيتعب بيشوف نتيجة",
  "إنت مسؤول عن نفسك",
  "ركز، اللي جاي محتاجك قوي",
  "كل تأخير وله سبب",
  "مافيش حاجة بتيجي بسهولة",
  "شد ضهرك بنفسك",
  "إوعى تكسل وانت قربت",
  "كمل حتى لو لوحدك",
  "الدنيا مش دايمًا عادلة بس انت لازم تكون قوي",
  "إرادتك أقوى من أي عائق",
  "إوعى تسيب حلمك في النص",
  "كل مرة تقوم فيها انت بتنتصر",
  "إشتغل على نفسك بصمت",
  "محدش هيحس بتعبك غيرك",
  "الطريق الصعب هو الصح",
  "اصبر، النتيجة تستاهل",
  "لو فشلت مرة ده مش آخر الطريق",
  "خليك واقف مهما حصل",
  "قوتك في استمرارك",
  "إوعى ترجع ورا",
  "انت قد المسؤولية",
  "النجاح محتاج نفس طويل",
  "كل تعب وليه مقابل",
  "شد حيلك، لسه بدري",
  "إوعى تفرط في مجهودك",
  "ركز في هدفك وبس",
  "كل يوم بتقرب أكتر",
  "التعب بيعدي والنجاح بيفضل",
  "قوم من غير أعذار",
  "اشتغل عشان نفسك",
  "ماتخليش حد يقلل منك",
  "انت مش أقل من حد",
  "خليك صبور ومكمل",
  "الحلم محتاج قلب جامد",
  "اللي بيكمل هو اللي بيكسب",
  "إوعى تيأس، دي لحظة وهتعدي",
  "استثمر في نفسك",
  "كمل، التعب ده شهادة",
  "إنت أقوى من الظروف",
  "النجاح مش حظ",
  "قوم وابدأ من جديد",
  "اشتغل على حلمك كل يوم",
  "إوعى تخاف من التعب",
  "كل خطوة ليها قيمة",
  "خليك ثابت",
  "الدنيا بتمتحن صبرك",
  "اللي بيصبر بيكسب",
  "إوعى توقف بدري",
  "كل تعب هيبان",
  "قوم واجري ورا حلمك",
  "خليك واثق",
  "إنت بتعمل اللي عليك",
  "النجاح بيحب اللي يتعبله",
  "شد حيلك شوية كمان",
  "إوعى تستسلم",
  "كمل، قربت",
  "إنت مش لوحدك، ربنا معاك",
  "إوعى تخلي التعب يغلبك",
  "كل مجهود محسوب",
  "الراحة لسه قدام",
  "كمل عشان نفسك",
  "اشتغل بإخلاص",
  "الطريق طويل بس يستاهل",
  "إنت بتبني نفسك",
  "إوعى تضعف دلوقتي",
  "اللي جاي أحسن",
  "ثق في ربنا وفي نفسك",
  "النجاح صبر مش سرعة",
  "كمل حتى الآخر",
  "إوعى تسيب نفسك",
  "قوم وخد خطوة",
  "انت على الطريق الصح",
  "كل يوم بتقوى",
  "إوعى تفقد الشغف",
  "كمل عشان حلمك",
  "التعب ده وسام",
  "خليك جدع مع نفسك",
  "النجاح بيستنى اللي يستحمل",
  "إوعى توقف",
  "انت قدها وزيادة",
  "كمل وماتبصش وراك",
  "كل يوم بيعدي انت بتكبر",
  "إنت بتعمل الصح",
  "إوعى تيأس مهما حصل",
  "النجاح قريب",
  "كمل، مفيش وقت للكسل",
  "شد حيلك، النهاية حلوة",
  "انت أقوى من أي عذر",
  "إوعى تضيع اللي بنيته",
  "كمل… انت على بعد خطوة"
];
  function showDailyMotivation() {
    const today = new Date().toLocaleDateString('ar-EG');
    const storedDate = localStorage.getItem('motivationDate');
    let message;

    if (storedDate !== today) {
      const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
      const index = dayOfYear % motivationMessages.length;
      message = motivationMessages[index];
      localStorage.setItem('motivationMessage', message);
      localStorage.setItem('motivationDate', today);
    } else {
      message = localStorage.getItem('motivationMessage');
    }
    motivationWidget.textContent = message;
  }

  // --- 4. منطق قائمة المهام والتقويم ---
  
  const taskForm = document.getElementById('task-form');
  const taskInput = document.getElementById('task-input');
  const taskSubmitBtn = document.getElementById('task-submit-btn');
  const taskList = document.getElementById('task-list');
  const clearAllBtn = document.getElementById('clear-all-btn');
  const clearBtnText = document.getElementById('clear-btn-text');
  
  const navYesterday = document.getElementById('nav-yesterday');
  const navToday = document.getElementById('nav-today');
  const navTomorrow = document.getElementById('nav-tomorrow');
  const navPicker = document.getElementById('nav-picker');
  const taskListTitle = document.getElementById('task-list-title');

  const calendarModal = document.getElementById('calendar-modal');
  const calendarCloseBtn = document.getElementById('calendar-close-btn');
  const calendarDatesGrid = document.getElementById('calendar-dates-grid');
  const calendarMonthYear = document.getElementById('calendar-month-year');
  const prevMonthBtn = document.getElementById('calendar-prev-month');
  const nextMonthBtn = document.getElementById('calendar-next-month');

  // عناصر مودال التأكيد (مشترك)
  const confirmationModal = document.getElementById('confirmation-modal');
  const confirmationMessage = document.getElementById('confirmation-message');
  const confirmBtn = document.getElementById('confirm-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  let onConfirmAction = null;

  let allTasks = {}; 
  let selectedDateKey = ''; 
  let selectedDate = new Date(); 
  let calendarDate = new Date(); 
  const dateKeys = {}; 

  // دوال مودال التأكيد
  function showConfirmation(message, onConfirm) {
    confirmationMessage.textContent = message;
    onConfirmAction = onConfirm;
    confirmationModal.style.display = 'flex';
  }

  function hideConfirmation() {
    confirmationModal.style.display = 'none';
    onConfirmAction = null;
  }
  
  confirmBtn.addEventListener('click', () => {
    if (typeof onConfirmAction === 'function') {
      onConfirmAction();
    }
    hideConfirmation();
  });
  cancelBtn.addEventListener('click', hideConfirmation);
  confirmationModal.addEventListener('click', (e) => {
    if (e.target === confirmationModal) hideConfirmation();
  });


  function formatDateKey(date) {
    return new Date(date.getTime() - (date.getTimezoneOffset() * 60000))
      .toISOString()
      .split('T')[0];
  }
  
  function setupDates() {
    const today = new Date();
    today.setHours(12, 0, 0, 0); 
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    dateKeys.today = formatDateKey(today);
    dateKeys.yesterday = formatDateKey(yesterday);
    dateKeys.tomorrow = formatDateKey(tomorrow);
  }

  function saveTasks() {
    localStorage.setItem('alZainTasks_v2', JSON.stringify(allTasks));
  }

  function loadTasks() {
    const storedTasks = localStorage.getItem('alZainTasks_v2');
    allTasks = storedTasks ? JSON.parse(storedTasks) : {};
  }
  
  function renderTasks() {
    taskList.innerHTML = '';
    const tasksForDay = allTasks[selectedDateKey] || [];
    
    tasksForDay.forEach((task, index) => {
      const li = document.createElement('li');
      li.className = 'task-item';
      li.dataset.index = index;
      if (task.completed) li.classList.add('completed');
      
      li.innerHTML = `
        <label class="task-content" for="task-${selectedDateKey}-${index}">
          <input type="checkbox" class="task-checkbox" data-index="${index}" id="task-${selectedDateKey}-${index}" ${task.completed ? 'checked' : ''}>
          <span>${task.text}</span>
        </label>
        <button class="delete-btn" aria-label="حذف المهمة" data-index="${index}">
          <i class="fas fa-trash"></i>
        </button>
      `;
      taskList.appendChild(li);
    });
  }
  
  function changeSelectedDay(dateObj) {
    selectedDate = dateObj;
    selectedDate.setHours(12, 0, 0, 0); 
    selectedDateKey = formatDateKey(selectedDate);

    let title = '';
    [navYesterday, navToday, navTomorrow, navPicker].forEach(btn => btn.classList.remove('active'));

    if (selectedDateKey === dateKeys.today) {
      title = 'مهام اليوم';
      navToday.classList.add('active');
    } else if (selectedDateKey === dateKeys.yesterday) {
      title = 'مهام الأمس';
      navYesterday.classList.add('active');
    } else if (selectedDateKey === dateKeys.tomorrow) {
      title = 'مهام الغد';
      navTomorrow.classList.add('active');
    } else {
      title = `مهام ${selectedDate.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' })}`;
      navPicker.classList.add('active');
    }

    taskListTitle.textContent = title;
    clearBtnText.textContent = "مسح الكل";
    
    const startOfToday = new Date();
    startOfToday.setHours(0, 0, 0, 0);
    const isPast = selectedDate < startOfToday;
    
    taskInput.disabled = isPast;
    taskSubmitBtn.disabled = isPast;
    taskInput.placeholder = isPast ? 'لا يمكن الإضافة لأيام ماضية' : 'أضف مهمة جديدة...';

    renderTasks();
  }

  taskForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = taskInput.value.trim();
    if (text !== '') {
      if (!allTasks[selectedDateKey]) allTasks[selectedDateKey] = [];
      allTasks[selectedDateKey].push({ text: text, completed: false });
      saveTasks();
      renderTasks();
      taskInput.value = '';
    }
  });

  taskList.addEventListener('click', (e) => {
    const target = e.target;
    const item = target.closest('.task-item');
    if (!item) return;
    
    const index = target.dataset.index;
    if (!index) return;
    
    const tasksForDay = allTasks[selectedDateKey] || [];
    if (!tasksForDay[index]) return; 

    if (target.closest('.delete-btn')) {
      tasksForDay.splice(index, 1); 
      saveTasks();
      renderTasks(); 
    } 
    else if (target.classList.contains('task-checkbox')) {
      tasksForDay[index].completed = target.checked;
      saveTasks();
      item.classList.toggle('completed', target.checked);
    }
  });
  
  clearAllBtn.addEventListener('click', () => {
    const tasksForDay = allTasks[selectedDateKey] || [];
    if (tasksForDay.length === 0) return;
    
    showConfirmation(
      `هل أنت متأكد أنك تريد مسح جميع المهام (${tasksForDay.length}) لهذا اليوم؟`, 
      () => {
        allTasks[selectedDateKey] = [];
        saveTasks();
        renderTasks();
      }
    );
  });

  navYesterday.addEventListener('click', () => changeSelectedDay(new Date(dateKeys.yesterday + 'T12:00:00')));
  navToday.addEventListener('click', () => changeSelectedDay(new Date(dateKeys.today + 'T12:00:00')));
  navTomorrow.addEventListener('click', () => changeSelectedDay(new Date(dateKeys.tomorrow + 'T12:00:00')));
  
  function renderCalendar(date) {
    calendarDate = new Date(date.getFullYear(), date.getMonth(), 1);
    const month = calendarDate.getMonth();
    const year = calendarDate.getFullYear();
    
    calendarMonthYear.textContent = `${date.toLocaleDateString('ar-EG', { month: 'long' })} ${year}`;
    calendarDatesGrid.innerHTML = '';
    
    const firstDayIndex = calendarDate.getDay(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    for (let i = 0; i < firstDayIndex; i++) {
      calendarDatesGrid.innerHTML += `<div class="date-cell empty"></div>`;
    }
    
    for (let day = 1; day <= daysInMonth; day++) {
      const cellDate = new Date(year, month, day);
      const cellDateKey = formatDateKey(cellDate);
      const classes = ['date-cell'];
      if (cellDateKey === dateKeys.today) classes.push('today');
      if (cellDateKey === selectedDateKey) classes.push('selected');
      
      calendarDatesGrid.innerHTML += `<div class="${classes.join(' ')}" data-day="${day}">${day}</div>`;
    }
  }

  navPicker.addEventListener('click', () => {
    renderCalendar(selectedDate); 
    calendarModal.style.display = 'flex';
  });

  calendarCloseBtn.addEventListener('click', () => {
    calendarModal.style.display = 'none';
  });
  calendarModal.addEventListener('click', (e) => {
    if (e.target === calendarModal) calendarModal.style.display = 'none';
  });

  prevMonthBtn.addEventListener('click', () => {
    calendarDate.setMonth(calendarDate.getMonth() - 1);
    renderCalendar(calendarDate);
  });
  nextMonthBtn.addEventListener('click', () => {
    calendarDate.setMonth(calendarDate.getMonth() + 1);
    renderCalendar(calendarDate);
  });

  calendarDatesGrid.addEventListener('click', (e) => {
    const cell = e.target.closest('.date-cell');
    if (!cell || cell.classList.contains('empty')) return;
    
    const day = parseInt(cell.dataset.day);
    const newSelectedDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), day);
    
    changeSelectedDay(newSelectedDate); 
    calendarModal.style.display = 'none'; 
  });
  
  
  // --- (جديد) 5. منطق الملاحظات الاحترافي ---
  
  const notesListEl = document.getElementById('notes-list');
  const addNoteBtn = document.getElementById('add-note-btn');
  const notesModal = document.getElementById('notes-modal');
  const notesModalCloseBtn = document.getElementById('notes-modal-close-btn');
  const notesModalTitle = document.getElementById('notes-modal-title');
  const noteTitleInput = document.getElementById('note-title-input');
  const noteContentInput = document.getElementById('note-content-input');
  const noteTimestampStatus = document.getElementById('note-timestamp-status');
  const saveNoteBtn = document.getElementById('save-note-btn');
  const deleteNoteBtn = document.getElementById('delete-note-btn');
  
  const PROFESSIONAL_NOTES_KEY = 'alZainProfessionalNotes_v1';
  let allNotes = [];
  let currentEditingNoteId = null;

  function loadProfessionalNotes() {
    const storedNotes = localStorage.getItem(PROFESSIONAL_NOTES_KEY);
    allNotes = storedNotes ? JSON.parse(storedNotes) : [];
    // فرز لضمان الأحدث أولاً
    allNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  }

  function saveProfessionalNotes() {
    // الفرز مرة أخرى قبل الحفظ لضمان الترتيب
    allNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    localStorage.setItem(PROFESSIONAL_NOTES_KEY, JSON.stringify(allNotes));
  }
  
  function formatNoteTimestamp(isoString) {
    const date = new Date(isoString);
    const timeString = date.toLocaleTimeString('ar-EG', {
      hour: '2-digit', minute: '2-digit'
    });
    const dateString = date.toLocaleDateString('ar-EG', {
      day: 'numeric', month: 'long', year: 'numeric'
    });
    return `${dateString}، ${timeString}`;
  }

  function renderNotesList() {
    notesListEl.innerHTML = ''; // إفراغ القائمة
    if (allNotes.length === 0) {
      notesListEl.innerHTML = '<li class="no-notes">لا توجد ملاحظات.. اضغط + للإضافة</li>';
      return;
    }
    
    allNotes.forEach(note => {
      const li = document.createElement('li');
      li.className = 'note-list-item';
      li.dataset.id = note.id;
      
      li.innerHTML = `
        <div class="note-item-details">
          <div class="note-item-title">${note.title || 'بدون عنوان'}</div>
          <div class="note-item-date">${formatNoteTimestamp(note.timestamp)}</div>
        </div>
        <i class="fas fa-chevron-left note-item-arrow"></i>
      `;
      
      li.addEventListener('click', () => openNoteModal(note.id));
      notesListEl.appendChild(li);
    });
  }

  function openNoteModal(noteId = null) {
    currentEditingNoteId = noteId;
    
    // تصفير الحقول
    noteTitleInput.value = '';
    noteContentInput.value = '';
    noteTimestampStatus.textContent = '';
    
    if (noteId) {
      // وضع التعديل
      const note = allNotes.find(n => n.id === noteId);
      if (!note) return;
      
      notesModalTitle.textContent = 'تعديل ملاحظة';
      noteTitleInput.value = note.title;
      noteContentInput.value = note.content;
      noteTimestampStatus.textContent = `آخر تحديث: ${formatNoteTimestamp(note.timestamp)}`;
      deleteNoteBtn.style.display = 'flex';
      
    } else {
      // وضع ملاحظة جديدة
      notesModalTitle.textContent = 'ملاحظة جديدة';
      noteTimestampStatus.textContent = 'سيتم حفظ الوقت عند الضغط على حفظ';
      deleteNoteBtn.style.display = 'none';
    }
    
    notesModal.style.display = 'flex';
  }

  function closeNoteModal() {
    notesModal.style.display = 'none';
    currentEditingNoteId = null;
  }

  function handleSaveNote() {
    const title = noteTitleInput.value.trim();
    const content = noteContentInput.value.trim();
    
    if (!title && !content) {
        // لا تحفظ ملاحظة فارغة تماماً
        return;
    }
    
    const timestamp = new Date().toISOString();
    
    if (currentEditingNoteId) {
      // تحديث ملاحظة موجودة
      const note = allNotes.find(n => n.id === currentEditingNoteId);
      if (note) {
        note.title = title || "بدون عنوان"; // عنوان افتراضي إذا كان فارغاً
        note.content = content;
        note.timestamp = timestamp;
      }
    } else {
      // إضافة ملاحظة جديدة
      const newNote = {
        id: crypto.randomUUID(),
        title: title || "بدون عنوان", // عنوان افتراضي إذا كان فارغاً
        content: content,
        timestamp: timestamp
      };
      allNotes.push(newNote); // الإضافة
    }
    
    saveProfessionalNotes();
    renderNotesList();
    closeNoteModal();
  }

  function handleDeleteNote() {
    if (!currentEditingNoteId) return;
    
    showConfirmation(
      "هل أنت متأكد من حذف هذه الملاحظة؟ لا يمكن التراجع عن هذا الإجراء.",
      () => {
        allNotes = allNotes.filter(note => note.id !== currentEditingNoteId);
        saveProfessionalNotes();
        renderNotesList();
        closeNoteModal();
      }
    );
  }
  
  // ربط أحداث مودال الملاحظات
  addNoteBtn.addEventListener('click', () => openNoteModal(null));
  notesModalCloseBtn.addEventListener('click', closeNoteModal);
  notesModal.addEventListener('click', (e) => {
    if(e.target === notesModal) closeNoteModal();
  });
  saveNoteBtn.addEventListener('click', handleSaveNote);
  deleteNoteBtn.addEventListener('click', handleDeleteNote);


  // --- 6. منطق المؤقت وساعة الإيقاف ---
  
  const timerDisplay = document.getElementById('timer-display');
  const timerTabTimer = document.getElementById('timer-tab-timer');
  const timerTabStopwatch = document.getElementById('timer-tab-stopwatch');
  const timerInputs = document.getElementById('timer-inputs');
  const minutesInput = document.getElementById('timer-minutes-input');
  const secondsInput = document.getElementById('timer-seconds-input');
  const startPauseBtn = document.getElementById('timer-start-pause-btn');
  const startPauseText = document.getElementById('timer-start-pause-text');
  const startPauseIcon = startPauseBtn.querySelector('i');
  const resetBtn = document.getElementById('timer-reset-btn');

  let timerMode = 'timer';
  let isRunning = false;
  let intervalId = null;
  let totalSeconds = 0;
  let elapsedSeconds = 0;
  let audioContext;

  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  } catch (e) {
    console.warn("Web Audio API is not supported in this browser");
  }

  function playBeep() {
    if (!audioContext) return;
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.5);
  }

  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }
  
  function updateTimerDisplay() {
    let secondsToShow = (timerMode === 'timer') ? totalSeconds - elapsedSeconds : elapsedSeconds;
    timerDisplay.textContent = formatTime(secondsToShow);
  }

  function tick() {
    elapsedSeconds++;
    if (timerMode === 'timer' && elapsedSeconds >= totalSeconds) {
      clearInterval(intervalId);
      intervalId = null;
      isRunning = false;
      playBeep();
      handleTimerReset(); 
    }
    updateTimerDisplay();
  }

  function handleStartPause() {
    if (isRunning) {
      clearInterval(intervalId);
      intervalId = null;
      isRunning = false;
      startPauseText.textContent = "ابدأ";
      startPauseIcon.className = "fas fa-play";
    } else {
      if (timerMode === 'timer') {
        if (elapsedSeconds === 0) { 
          const minutes = parseInt(minutesInput.value) || 0;
          const seconds = parseInt(secondsInput.value) || 0;
          totalSeconds = (minutes * 60) + seconds;
        }
        if (totalSeconds <= 0) return;
      } else { 
        totalSeconds = Infinity; 
      }
      intervalId = setInterval(tick, 1000);
      isRunning = true;
      startPauseText.textContent = "إيقاف مؤقت";
      startPauseIcon.className = "fas fa-pause";
    }
  }

  function handleTimerReset() {
    clearInterval(intervalId);
    intervalId = null;
    isRunning = false;
    elapsedSeconds = 0;
    totalSeconds = 0;
    minutesInput.value = '';
    secondsInput.value = '';
    startPauseText.textContent = "ابدأ";
    startPauseIcon.className = "fas fa-play";
    updateTimerDisplay();
  }

  timerTabTimer.addEventListener('click', () => {
    timerMode = 'timer';
    timerTabTimer.classList.add('active');
    timerTabStopwatch.classList.remove('active');
    timerInputs.style.display = 'flex';
    handleTimerReset();
  });

  timerTabStopwatch.addEventListener('click', () => {
    timerMode = 'stopwatch';
    timerTabStopwatch.classList.add('active');
    timerTabTimer.classList.remove('active');
    timerInputs.style.display = 'none';
    handleTimerReset();
  });

  startPauseBtn.addEventListener('click', handleStartPause);
  resetBtn.addEventListener('click', handleTimerReset);


  // --- 7. منطق قسم القرآن ---
  
  const QURAN_API_BASE = 'https://api.quran.com/api/v4';
  const quranContent = document.getElementById('quran-content');
  const customSurahSelector = document.getElementById('custom-surah-selector');
  const customSurahText = document.getElementById('custom-surah-text');
  const customSurahOptions = document.getElementById('custom-surah-options');
  const customReciterSelector = document.getElementById('custom-reciter-selector');
  const customReciterText = document.getElementById('custom-reciter-text');
  const customReciterOptions = document.getElementById('custom-reciter-options');
  const quranAudioPlayer = document.getElementById('quran-audio-player');
  const quranBookmarkWidget = document.getElementById('quran-bookmark-widget');
  
  let quranBookmark = null;
  let chaptersData = []; 
  let recitersData = [];
  let selectedReciterId = null;
  let selectedChapterId = null;
  const DEFAULT_RECITER_ID = 7; // ياسر الدوسري
  const RECITER_STORAGE_KEY = 'selectedReciterId';

  function loadBookmark() {
    const stored = localStorage.getItem('quranBookmark');
    if (stored) {
      quranBookmark = JSON.parse(stored);
      showBookmarkWidget(quranBookmark);
    }
  }

  function showBookmarkWidget(bookmark) {
    quranBookmarkWidget.innerHTML = `
      <i class="fas fa-bookmark"></i> آخر وقوف: 
      <strong>سورة ${bookmark.surahName}، آية ${bookmark.verseNum}</strong>
      <small>(اضغط للذهاب إليها)</small>
    `;
    quranBookmarkWidget.style.display = 'block';
  }

  quranBookmarkWidget.addEventListener('click', () => {
    if (quranBookmark) {
      const option = customSurahOptions.querySelector(`.custom-option[data-value="${quranBookmark.surahId}"]`);
      if(option) {
        customSurahText.textContent = option.textContent;
        const oldSelected = customSurahOptions.querySelector('.selected');
        if (oldSelected) oldSelected.classList.remove('selected');
        option.classList.add('selected');
      }
      selectedChapterId = quranBookmark.surahId; 
      fetchSurah(quranBookmark.surahId, quranBookmark.verseKey);
      fetchAudio(selectedReciterId, quranBookmark.surahId);
      switchPage('app-quran');
    }
  });

  
  async function fetchSurahList() {
    try {
      const response = await fetch(`${QURAN_API_BASE}/chapters?language=ar`);
      if (!response.ok) throw new Error('Failed to fetch chapters');
      const data = await response.json();
      chaptersData = data.chapters; 
      populateCustomSurahSelector(chaptersData);
    } catch (error) {
      console.error("Error fetching surah list:", error);
      quranContent.textContent = 'عفواً، حدث خطأ أثناء جلب قائمة السور.';
    }
  }
  
  function populateCustomSurahSelector(chapters) {
    customSurahOptions.innerHTML = ''; 
    chapters.forEach(chapter => {
      const option = document.createElement('div');
      option.className = 'custom-option';
      option.textContent = `${chapter.id}. ${chapter.name_arabic} (${chapter.name_simple})`;
      option.dataset.value = chapter.id;
      option.dataset.bismillah = chapter.bismillah_pre;
      option.setAttribute('role', 'option');
      
      option.addEventListener('click', (e) => {
        e.stopPropagation(); 
        customSurahText.textContent = option.textContent; 
        customSurahSelector.classList.remove('open'); 
        customSurahOptions.classList.remove('open');
        customSurahSelector.setAttribute('aria-expanded', 'false');
        
        const oldSelected = customSurahOptions.querySelector('.selected');
        if (oldSelected) oldSelected.classList.remove('selected');
        option.classList.add('selected');
        selectedChapterId = option.dataset.value;
        fetchSurah(selectedChapterId); 
        fetchAudio(selectedReciterId, selectedChapterId);
      });
      customSurahOptions.appendChild(option);
    });
  }

  async function fetchSurah(chapterId, highlightKey = null) {
    if (!chapterId) {
      quranContent.innerHTML = 'الرجاء اختيار سورة لعرضها';
      quranContent.classList.add('loading');
      return;
    }
    
    quranContent.innerHTML = 'جارٍ التحميل';
    quranContent.classList.add('loading');
    
    try {
      const response = await fetch(`${QURAN_API_BASE}/quran/verses/uthmani?chapter_number=${chapterId}`);
      if (!response.ok) throw new Error('Failed to fetch verses');
      const data = await response.json();
      const surahName = chaptersData.find(c => c.id == chapterId)?.name_arabic || '';
      renderSurah(data.verses, surahName, highlightKey); 
      
      const selectedOption = customSurahOptions.querySelector(`.custom-option[data-value="${chapterId}"]`);
      if (selectedOption && selectedOption.dataset.bismillah === 'true') {
        quranContent.insertAdjacentHTML('afterbegin', '<div class="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>');
      }
      
      if (highlightKey) {
        const element = document.getElementById('bookmarked-verse');
        if (element) {
          setTimeout(() => { 
            quranContent.scrollTop = element.offsetTop - (quranContent.clientHeight / 3);
          }, 100);
        }
      }
    } catch (error) {
      console.error("Error fetching surah:", error);
      quranContent.textContent = 'عفواً، حدث خطأ أثناء جلب السورة.';
    }
  }
  
  function renderSurah(verses, surahName, highlightKey = null) {
    quranContent.innerHTML = ''; 
    quranContent.classList.remove('loading');
    let content = '';
    verses.forEach(verse => {
      const verseNumber = verse.verse_key.split(':')[1]; 
      const isBookmarked = verse.verse_key === highlightKey;
      content += `<span class="verse">${verse.text_uthmani}</span> 
                  <span class="verse-number" 
                        data-verse-key="${verse.verse_key}" 
                        data-surah-name="${surahName}"
                        ${isBookmarked ? 'id="bookmarked-verse"' : ''}>
                    ${verseNumber}
                  </span> `;
    });
    quranContent.innerHTML = content;
  }
  
  quranContent.addEventListener('click', (e) => {
    const verseNumberEl = e.target.closest('.verse-number');
    if (!verseNumberEl) return;

    const key = verseNumberEl.dataset.verseKey;
    const surahName = verseNumberEl.dataset.surahName;
    const surahId = key.split(':')[0];
    const verseNum = key.split(':')[1];
    
    quranBookmark = { surahId, surahName, verseKey: key, verseNum };
    localStorage.setItem('quranBookmark', JSON.stringify(quranBookmark));
    showBookmarkWidget(quranBookmark);

    const oldBookmark = document.getElementById('bookmarked-verse');
    if(oldBookmark) oldBookmark.id = '';
    verseNumberEl.id = 'bookmarked-verse';
  });
  
  customSurahSelector.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = customSurahOptions.classList.toggle('open');
    customSurahSelector.classList.toggle('open');
    customSurahSelector.setAttribute('aria-expanded', isOpen.toString());
    customReciterOptions.classList.remove('open');
    customReciterSelector.classList.remove('open');
    customReciterSelector.setAttribute('aria-expanded', 'false');
  });
  
  async function fetchReciterList() {
    try {
      const response = await fetch(`${QURAN_API_BASE}/resources/recitations?language=ar`);
      if (!response.ok) throw new Error('Failed to fetch reciters');
      const data = await response.json();
      recitersData = data.recitations.filter(rec => rec.style === "Murattal" || rec.style === "Mujawwad");
      populateReciterSelector(recitersData);
    } catch (error) {
      console.error("Error fetching reciter list:", error);
      customReciterText.textContent = "خطأ في جلب القراء";
    }
  }

  function populateReciterSelector(reciters) {
    customReciterOptions.innerHTML = '';
    let defaultReciterName = "اختر القارئ";
    const uniqueRecitersMap = new Map();
    reciters.forEach(reciter => {
      if (!uniqueRecitersMap.has(reciter.reciter_name)) {
        uniqueRecitersMap.set(reciter.reciter_name, reciter);
      } else if (reciter.style === "Murattal") {
         uniqueRecitersMap.set(reciter.reciter_name, reciter);
      }
    });
    const uniqueReciters = Array.from(uniqueRecitersMap.values());
    const savedReciterId = parseInt(localStorage.getItem(RECITER_STORAGE_KEY));
    let reciterToSelect = uniqueReciters.find(r => r.id === savedReciterId) || 
                          uniqueReciters.find(r => r.id === DEFAULT_RECITER_ID) || 
                          (uniqueReciters.length > 0 ? uniqueReciters[0] : null);

    uniqueReciters.forEach(reciter => {
      const option = document.createElement('div');
      option.className = 'custom-option';
      option.textContent = reciter.reciter_name;
      option.dataset.value = reciter.id;
      option.setAttribute('role', 'option');
      
      if (reciterToSelect && reciter.id === reciterToSelect.id) {
          option.classList.add('selected');
          defaultReciterName = reciter.reciter_name;
          selectedReciterId = reciter.id;
      }

      option.addEventListener('click', (e) => {
        e.stopPropagation(); 
        customReciterText.textContent = option.textContent; 
        customReciterSelector.classList.remove('open'); 
        customReciterOptions.classList.remove('open');
        customReciterSelector.setAttribute('aria-expanded', 'false');
        
        const oldSelected = customReciterOptions.querySelector('.selected');
        if (oldSelected) oldSelected.classList.remove('selected');
        option.classList.add('selected');

        selectedReciterId = parseInt(option.dataset.value);
        localStorage.setItem(RECITER_STORAGE_KEY, selectedReciterId);
        
        if (selectedChapterId) {
            fetchAudio(selectedReciterId, selectedChapterId);
        }
      });
      customReciterOptions.appendChild(option);
    });
    
    if (!selectedReciterId && reciterToSelect) {
        selectedReciterId = reciterToSelect.id;
        defaultReciterName = reciterToSelect.reciter_name;
        const firstOption = customReciterOptions.querySelector(`.custom-option[data-value="${reciterToSelect.id}"]`);
        if(firstOption) firstOption.classList.add('selected');
        localStorage.setItem(RECITER_STORAGE_KEY, selectedReciterId);
    }
    customReciterText.textContent = defaultReciterName;
  }
  
  async function fetchAudio(reciterId, chapterId) {
    if (!reciterId || !chapterId) {
      quranAudioPlayer.src = '';
      return;
    }
    try {
      quranAudioPlayer.src = ''; 
      const response = await fetch(`${QURAN_API_BASE}/chapter_recitations/${reciterId}/${chapterId}`);
      if (!response.ok) throw new Error('Failed to fetch audio file');
      const data = await response.json();
      
      if (data.audio_file && data.audio_file.audio_url) {
        quranAudioPlayer.src = data.audio_file.audio_url;
      } else {
        throw new Error('Audio file URL not found');
      }
    } catch (error) {
      console.error("Error fetching audio:", error);
      quranAudioPlayer.src = '';
    }
  }
  
  customReciterSelector.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = customReciterOptions.classList.toggle('open');
    customReciterSelector.classList.toggle('open');
    customReciterSelector.setAttribute('aria-expanded', isOpen.toString());
    customSurahOptions.classList.remove('open');
    customSurahSelector.classList.remove('open');
    customSurahSelector.setAttribute('aria-expanded', 'false');
  });

  window.addEventListener('click', () => {
    if (customSurahOptions.classList.contains('open')) {
      customSurahOptions.classList.remove('open');
      customSurahSelector.classList.remove('open');
      customSurahSelector.setAttribute('aria-expanded', 'false');
    }
    if (customReciterOptions.classList.contains('open')) {
      customReciterOptions.classList.remove('open');
      customReciterSelector.classList.remove('open');
      customReciterSelector.setAttribute('aria-expanded', 'false');
    }
  });
  
  
  // --- 8. منطق المسبحة والأذكار ---
  
  const dhikrTextEl = document.getElementById('dhikr-text');
  const tasbeehCountCurrentEl = document.getElementById('tasbeeh-count-current');
  const tasbeehTapBtn = document.getElementById('tasbeeh-tap-btn');
  const tasbeehResetBtn = document.getElementById('tasbeeh-reset-btn');
  const tasbeehChangeBtn = document.getElementById('tasbeeh-change-btn');
  const tasbeehTotalEl = document.getElementById('tasbeeh-total-count');

  let tasbeehCount = 0;
  let tasbeehTotal = 0;
  let currentDhikrIndex = 0;
  const dhikrList = [
    "سبحان الله", "الحمد لله", "لا إله إلا الله", "الله أكبر", 
    "لا حول ولا قوة إلا بالله", "سبحان الله وبحمده", "سبحان الله العظيم", "أستغفر الله"
  ];

  function updateTasbeehUI() {
    dhikrTextEl.textContent = dhikrList[currentDhikrIndex];
    tasbeehCountCurrentEl.textContent = tasbeehCount;
    tasbeehTotalEl.textContent = `مجموع التسبيحات: ${tasbeehTotal}`;
  }

  function saveTasbeehState() {
    localStorage.setItem('tasbeehState', JSON.stringify({ 
      count: tasbeehCount, total: tasbeehTotal, index: currentDhikrIndex 
    }));
  }

  function loadTasbeehState() {
    const saved = localStorage.getItem('tasbeehState');
    if (saved) {
      const state = JSON.parse(saved);
      tasbeehCount = state.count || 0;
      tasbeehTotal = state.total || 0;
      currentDhikrIndex = state.index || 0;
    }
    updateTasbeehUI();
  }
  
  tasbeehTapBtn.addEventListener('click', () => {
    tasbeehCount++;
    tasbeehTotal++;
    updateTasbeehUI();
    saveTasbeehState();
  });
  
  tasbeehResetBtn.addEventListener('click', () => {
    tasbeehTotal -= tasbeehCount;
    if(tasbeehTotal < 0) tasbeehTotal = 0;
    tasbeehCount = 0;
    updateTasbeehUI();
    saveTasbeehState();
  });
  
  tasbeehChangeBtn.addEventListener('click', () => {
    tasbeehTotal -= tasbeehCount;
    if(tasbeehTotal < 0) tasbeehTotal = 0;
    currentDhikrIndex = (currentDhikrIndex + 1) % dhikrList.length;
    tasbeehCount = 0;
    updateTasbeehUI();
    saveTasbeehState();
  });
  
  const adhkarSabahToggle = document.getElementById('adhkar-sabah-toggle');
  const adhkarSabahContent = document.getElementById('adhkar-sabah-content');
  const adhkarMasaaToggle = document.getElementById('adhkar-masaa-toggle');
  const adhkarMasaaContent = document.getElementById('adhkar-masaa-content');

  function toggleAdhkar(header, content) {
    const isActive = content.classList.toggle('active');
    header.classList.toggle('active', isActive);
    header.querySelector('.toggle-icon').classList.toggle('active', isActive);
  }

  adhkarSabahToggle.addEventListener('click', () => {
    toggleAdhkar(adhkarSabahToggle, adhkarSabahContent);
    if (adhkarMasaaContent.classList.contains('active')) {
      toggleAdhkar(adhkarMasaaToggle, adhkarMasaaContent);
    }
  });

  adhkarMasaaToggle.addEventListener('click', () => {
    toggleAdhkar(adhkarMasaaToggle, adhkarMasaaContent);
    if (adhkarSabahContent.classList.contains('active')) {
      toggleAdhkar(adhkarSabahToggle, adhkarSabahContent);
    }
  });
  
  function autoOpenAdhkar() {
    const hour = new Date().getHours();
    if (hour >= 4 && hour < 12) {
      if (!adhkarSabahContent.classList.contains('active')) {
          toggleAdhkar(adhkarSabahToggle, adhkarSabahContent);
      }
    } else if (hour >= 15 && hour < 20) {
      if (!adhkarMasaaContent.classList.contains('active')) {
          toggleAdhkar(adhkarMasaaToggle, adhkarMasaaContent);
      }
    }
  }


  // --- 9. منطق مواقيت الصلاة والإعدادات ---
  
  const prayerWidget = document.getElementById('next-prayer-widget');
  const prayerLabel = document.getElementById('next-prayer-label');
  const prayerCountdown = document.getElementById('next-prayer-countdown');
  const prayerList = document.getElementById('prayer-times-list');
  
  let prayerTimesData = null;
  let countdownInterval = null;
  let notifiedPrayers = {};
  
  const settings = {};
  const settingsModal = document.getElementById('settings-modal');
  const settingsToggle = document.getElementById('settingsToggle');
  const settingsCloseBtn = document.getElementById('settings-close-btn');
  const autoDetectBtn = document.getElementById('auto-detect-btn');
  const manualSaveBtn = document.getElementById('manual-save-btn');
  const cityInput = document.getElementById('city-input');
  const countryInput = document.getElementById('country-input');
  const settingsStatus = document.getElementById('settings-status');
  const enableNotificationsBtn = document.getElementById('enable-notifications-btn');

  function loadSettings() {
    const storedSettings = localStorage.getItem('alZainSettings');
    Object.assign(settings, storedSettings ? JSON.parse(storedSettings) : {
      latitude: null, longitude: null, city: null, country: null
    });
    if(settings.city) cityInput.value = settings.city;
    if(settings.country) countryInput.value = settings.country;
  }

  function saveSettings() {
    localStorage.setItem('alZainSettings', JSON.stringify(settings));
    showStatusMessage('تم حفظ الإعدادات بنجاح', 'success');
    fetchPrayerTimes();
  }

  function showStatusMessage(message, type = 'error') {
    settingsStatus.textContent = message;
    settingsStatus.className = `status-message ${type}`;
    settingsStatus.style.display = 'block';
    setTimeout(() => { settingsStatus.style.display = 'none'; }, 4000);
  }

  settingsToggle.addEventListener('click', () => {
    settingsModal.style.display = 'flex';
    updateNotificationButton();
  });
  settingsCloseBtn.addEventListener('click', () => {
    settingsModal.style.display = 'none';
  });
  settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) settingsModal.style.display = 'none';
  });

  autoDetectBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      showStatusMessage('المتصفح لا يدعم التحديد التلقائي.');
      return;
    }
    autoDetectBtn.disabled = true;
    autoDetectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ التحديد...';
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        settings.latitude = position.coords.latitude;
        settings.longitude = position.coords.longitude;
        settings.city = null;
        settings.country = null;
        saveSettings();
        autoDetectBtn.disabled = false;
        autoDetectBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i> تحديد الموقع تلقائياً';
        setTimeout(() => { settingsModal.style.display = 'none'; }, 1500);
      },
      (error) => {
        autoDetectBtn.disabled = false;
        autoDetectBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i> تحديد الموقع تلقائياً';
        showStatusMessage('فشل التحديد. الرجاء السماح بالوصول للموقع.');
      }
    );
  });

  manualSaveBtn.addEventListener('click', () => {
    const city = cityInput.value.trim();
    const country = countryInput.value.trim();
    if (city && country) {
      settings.city = city;
      settings.country = country;
      settings.latitude = null;
      settings.longitude = null;
      saveSettings();
      setTimeout(() => { settingsModal.style.display = 'none'; }, 1500);
    } else {
      showStatusMessage('الرجاء إدخال المدينة والدولة.');
    }
  });

  // --- منطق الإشعارات ---
  function updateNotificationButton() {
    if (!('Notification' in window)) {
      enableNotificationsBtn.textContent = 'الإشعارات غير مدعومة';
      enableNotificationsBtn.disabled = true;
    } else if (Notification.permission === 'granted') {
      enableNotificationsBtn.textContent = 'تم تفعيل الإشعارات';
      enableNotificationsBtn.disabled = true;
    } else if (Notification.permission === 'denied') {
      enableNotificationsBtn.textContent = 'الإشعارات محظورة';
      enableNotificationsBtn.disabled = true;
    } else {
      enableNotificationsBtn.textContent = 'تفعيل الإشعارات';
      enableNotificationsBtn.disabled = false;
    }
  }

  function showNotification(title, body) {
    if (Notification.permission === 'granted') {
      new Notification(title, { body: body, icon: 'task48.png' });
    }
  }

  enableNotificationsBtn.addEventListener('click', () => {
    if (!('Notification' in window)) return;
    Notification.requestPermission().then(permission => {
      updateNotificationButton();
      if (permission === 'granted') {
        showStatusMessage('تم تفعيل الإشعارات بنجاح', 'success');
        showNotification('أهلاً بك', 'سيتم تنبيهك عند حلول وقت الصلاة.');
      } else {
        showStatusMessage('لم يتم تفعيل الإشعارات.', 'error');
      }
    });
  });
  updateNotificationButton();

  // --- منطق مواقيت الصلاة ---
  async function fetchPrayerTimes() {
    let url = '';
    const dateString = new Date().toISOString().split('T')[0];
    
    if (settings.latitude && settings.longitude) {
      url = `https://api.aladhan.com/v1/timings/${dateString}?latitude=${settings.latitude}&longitude=${settings.longitude}&method=5`;
    } else if (settings.city && settings.country) {
      url = `https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${settings.city}&country=${settings.country}&method=5`;
    } else {
      prayerWidget.classList.remove('loading');
      prayerLabel.textContent = 'مواقيت الصلاة';
      prayerCountdown.textContent = 'الرجاء تحديد موقعك';
      return;
    }
    
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch prayer times');
      const data = await response.json();
      prayerTimesData = data.data.timings;
      
      // (مُزال) تم حذف تحديث التاريخ الهجري
      
      renderPrayerTimes(prayerTimesData);
      startPrayerCountdown(prayerTimesData);
    } catch (error) {
      console.error("Error fetching prayer times:", error);
      prayerWidget.classList.remove('loading');
      prayerLabel.textContent = 'خطأ في جلب المواقيت';
      prayerCountdown.textContent = 'أعد المحاولة';
    }
  }

  function renderPrayerTimes(times) {
    prayerList.innerHTML = '';
    const prayerNames = {
      Fajr: "الفجر", Dhuhr: "الظهر", Asr: "العصر", Maghrib: "المغرب", Isha: "العشاء"
    };
    
    ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].forEach(key => {
      const li = document.createElement('li');
      li.className = 'prayer-item';
      li.id = `prayer-${key}`;
      const [hour, minute] = times[key].split(':').map(Number);
      const timeString = new Date(1970, 0, 1, hour, minute).toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true
      });
      li.innerHTML = `
        <span class="prayer-item-name">${prayerNames[key]}</span>
        <span class="prayer-item-time">${timeString}</span>
      `;
      prayerList.appendChild(li);
    });
  }

  function startPrayerCountdown(times) {
    if (countdownInterval) clearInterval(countdownInterval);
    const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
    const prayerNamesAr = { Fajr: "الفجر", Dhuhr: "الظهر", Asr: "العصر", Maghrib: "المغرب", Isha: "العشاء" };

    countdownInterval = setInterval(() => {
      const now = new Date();
      let nextPrayerName = null;
      let nextPrayerTime = null;

      const prayerDateObjects = prayerOrder.map(key => {
        const [hour, minute] = times[key].split(':').map(Number);
        const date = new Date();
        date.setHours(hour, minute, 0, 0);
        return { name: key, time: date };
      });

      for (const prayer of prayerDateObjects) {
        if (prayer.time > now) {
          nextPrayerName = prayer.name;
          nextPrayerTime = prayer.time;
          break;
        }
      }

      if (!nextPrayerTime) {
        nextPrayerName = 'Fajr';
        const [hour, minute] = times.Fajr.split(':').map(Number);
        nextPrayerTime = new Date();
        nextPrayerTime.setDate(nextPrayerTime.getDate() + 1); 
        nextPrayerTime.setHours(hour, minute, 0, 0);
      }
      
      const diff = nextPrayerTime.getTime() - now.getTime();
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      const countdownString = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      
      prayerWidget.classList.remove('loading');
      prayerLabel.textContent = `الوقت المتبقي لـ ${prayerNamesAr[nextPrayerName]}`;
      prayerCountdown.textContent = countdownString;
      
      document.querySelectorAll('.prayer-item').forEach(item => item.classList.remove('highlight'));
      const nextPrayerEl = document.getElementById(`prayer-${nextPrayerName}`);
      if(nextPrayerEl) nextPrayerEl.classList.add('highlight');
      
      if (nextPrayerName === 'Fajr' && hours > 12) {
         notifiedPrayers = {};
      }

      if (diff < 1000 && diff >= 0 && !notifiedPrayers[nextPrayerName]) {
        showNotification(`حان الآن وقت صلاة ${prayerNamesAr[nextPrayerName]}`, `"أَقِمِ الصَّلَاةَ لِذِكْرِي"`);
        notifiedPrayers[nextPrayerName] = true;
      }
    }, 1000);
  }

  // --- 10. منطق التنقل بين الصفحات ---
  
  const navButtons = document.querySelectorAll('.nav-btn');
  const appPages = document.querySelectorAll('.app-page');
  
  // (جديد) التحقق من الاسم عند الانتقال
  const nameModal = document.getElementById('name-modal');
  const userNameInput = document.getElementById('user-name-input');
  const saveNameBtn = document.getElementById('save-name-btn');
  
  function switchPage(pageId) {
    // إذا انتقل لصفحة التحديات وليس لديه اسم، أظهر المودال
    if (pageId === 'app-challenges') {
      const savedName = localStorage.getItem('alZainUserName');
      if (!savedName) {
        nameModal.style.display = 'flex';
        // لا ننتقل حتى يكتب الاسم، أو ننتقل ونظهر المودال فوقها
      }
    }

    appPages.forEach(page => {
      page.classList.remove('active');
      if (scrollObserver) {
        page.querySelectorAll('.reveal-on-scroll').forEach(el => scrollObserver.unobserve(el));
      }
    });
    
    const newPage = document.getElementById(pageId);
    newPage.classList.add('active');
    
    const itemsToAnimate = newPage.querySelectorAll('.reveal-on-scroll');
    if (scrollObserver) {
      itemsToAnimate.forEach(el => {
        el.classList.remove('visible');
        scrollObserver.observe(el);
      });
    }
    
    navButtons.forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.page === pageId) btn.classList.add('active');
    });
  }
  
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => switchPage(btn.dataset.page));
  });

  // منطق حفظ الاسم
  saveNameBtn.addEventListener('click', () => {
    const name = userNameInput.value.trim();
    if (name) {
      localStorage.setItem('alZainUserName', name);
      nameModal.style.display = 'none';
      updateUserStatsUI(); // تحديث واجهة التحديات بالاسم
    }
  });

  // --- 11. منطق التحريك عند الظهور ---
  let scrollObserver = null;
  
  function createScrollObserver() {
    if (!('IntersectionObserver' in window)) {
      document.querySelectorAll('.reveal-on-scroll').forEach(el => el.classList.add('visible'));
      return;
    }
  
    scrollObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
          scrollObserver.unobserve(entry.target);
        }
      });
    }, { root: null, threshold: 0.1, rootMargin: '0px 0px -20px 0px' });
    
    const activePage = document.querySelector('.app-page.active');
    if (activePage) {
      activePage.querySelectorAll('.reveal-on-scroll').forEach(el => {
        scrollObserver.observe(el);
      });
    }
  }

  // --- 12. (جديد) منطق التحديات والنقاط ---

  const challengesListContainer = document.getElementById('challenges-list-container');
  const userPointsDisplay = document.getElementById('user-points-display');
  const nextLevelDisplay = document.getElementById('next-level-display');
  const pointsProgressFill = document.getElementById('points-progress-fill');
  const challengeUserName = document.getElementById('challenge-user-name');
  const userLevelText = document.getElementById('user-level-text');
  
  const addChallengeModal = document.getElementById('add-challenge-modal');
  const openChallengeModalBtn = document.getElementById('open-challenge-modal-btn');
  const closeChallengeModalBtn = document.getElementById('close-challenge-modal');
  const saveChallengeBtn = document.getElementById('save-challenge-btn');
  
  const titleInput = document.getElementById('challenge-title-input');
  const durationInput = document.getElementById('challenge-duration-input');
  const pointsInput = document.getElementById('challenge-points-input');

  // (جديد) عناصر مودال عرض المستويات
  const showLevelsBtn = document.getElementById('show-levels-btn');
  const levelsModal = document.getElementById('levels-modal');
  const closeLevelsModalBtn = document.getElementById('close-levels-modal');
  const levelsListContainer = document.getElementById('levels-list-container');

  let userPoints = 0;
  let challenges = [];
  
  function loadChallengeData() {
    userPoints = parseInt(localStorage.getItem('alZainUserPoints') || '0');
    challenges = JSON.parse(localStorage.getItem('alZainChallenges') || '[]');
    updateUserStatsUI();
    renderChallenges();
  }
  
  function saveChallengeData() {
    localStorage.setItem('alZainUserPoints', userPoints);
    localStorage.setItem('alZainChallenges', JSON.stringify(challenges));
    updateUserStatsUI();
  }

  // (معدل) مستويات أصعب
  const LEVELS = [
    { name: 'مبتدئ', threshold: 0, color: '#666' },
    { name: 'برونزي', threshold: 500, color: '#cd7f32' },
    { name: 'فضي', threshold: 1500, color: '#c0c0c0' },
    { name: 'ذهبي', threshold: 3000, color: '#ffd700' },
    { name: 'ماسي', threshold: 5000, color: '#b9f2ff' }
  ];

  function getLevel(points) {
    // البحث عن أعلى مستوى وصل له المستخدم
    for (let i = LEVELS.length - 1; i >= 0; i--) {
      if (points >= LEVELS[i].threshold) {
        return {
          current: LEVELS[i],
          next: LEVELS[i + 1] || null
        };
      }
    }
    return { current: LEVELS[0], next: LEVELS[1] };
  }

  function updateUserStatsUI() {
    const name = localStorage.getItem('alZainUserName') || 'يا بطل';
    challengeUserName.textContent = `مرحبًا ، ${name}`;
    
    const levelData = getLevel(userPoints);
    userLevelText.textContent = levelData.current.name;
    userPointsDisplay.textContent = `${userPoints} نقطة`;
    
    if (levelData.next) {
      const prevThreshold = levelData.current.threshold;
      const nextThreshold = levelData.next.threshold;
      const currentProgress = userPoints - prevThreshold;
      const totalNeeded = nextThreshold - prevThreshold;
      const percent = Math.min(100, (currentProgress / totalNeeded) * 100);
      
      pointsProgressFill.style.width = `${percent}%`;
      nextLevelDisplay.textContent = `المستوى التالي: ${nextThreshold}`;
    } else {
      pointsProgressFill.style.width = `100%`;
      nextLevelDisplay.textContent = `الحد الأقصى!`;
    }
  }

  function showLevelsInfo() {
    levelsListContainer.innerHTML = '';
    const currentLevelName = getLevel(userPoints).current.name;

    LEVELS.forEach(level => {
      const div = document.createElement('div');
      div.className = `level-item ${level.name === currentLevelName ? 'active-level' : ''}`;
      div.innerHTML = `
        <span class="level-name" style="color: ${level.color}">${level.name}</span>
        <span class="level-points">${level.threshold} نقطة</span>
      `;
      levelsListContainer.appendChild(div);
    });
    levelsModal.style.display = 'flex';
  }

  showLevelsBtn.addEventListener('click', showLevelsInfo);
  closeLevelsModalBtn.addEventListener('click', () => levelsModal.style.display = 'none');
  levelsModal.addEventListener('click', (e) => {
    if(e.target === levelsModal) levelsModal.style.display = 'none';
  });
  
  function renderChallenges() {
    challengesListContainer.innerHTML = '';
    
    if (challenges.length === 0) {
      challengesListContainer.innerHTML = '<p id="no-challenges-msg" style="text-align: center; color: var(--muted);">لا توجد تحديات نشطة. أضف تحدي جديد</p>';
      return;
    }
    
    challenges.forEach(ch => {
      const progressPercent = (ch.currentDay / ch.totalDays) * 100;
      let dotsHTML = '';
      // عرض النقاط (dots) بحد أقصى 7 لتجنب الزحام، أو شريط بسيط
      const maxDots = Math.min(ch.totalDays, 10); 
      for(let i=0; i<maxDots; i++) {
        dotsHTML += `<div class="day-dot ${i < ch.currentDay ? 'active' : ''}"></div>`;
      }

      // التحقق مما إذا تم تسجيل اليوم
      const lastCheckIn = new Date(ch.lastCheckIn).toDateString();
      const today = new Date().toDateString();
      const isCheckedToday = (lastCheckIn === today);

      const div = document.createElement('div');
      div.className = 'challenge-card';
      div.innerHTML = `
        <div class="challenge-header">
          <span class="challenge-title">${ch.title}</span>
          <span class="challenge-points-badge">${ch.pointsReward} نقطة</span>
        </div>
        <div style="font-size: 0.85rem; color: var(--muted);">
           التقدم: ${ch.currentDay} / ${ch.totalDays} يوم
        </div>
        <div class="challenge-progress">
          ${dotsHTML}
        </div>
        <div class="challenge-actions">
          <button class="challenge-btn btn-give-up" onclick="window.resetChallenge('${ch.id}')">
            استسلام / إعادة
          </button>
          <button class="challenge-btn btn-check-in" 
            ${isCheckedToday ? 'disabled' : ''} 
            onclick="window.checkInChallenge('${ch.id}')">
            ${isCheckedToday ? 'تم اليوم ' : 'تسجيل إنجاز اليوم'}
          </button>
        </div>
      `;
      challengesListContainer.appendChild(div);
    });
  }

  // إضافة دوال التحدي للـ window لتكون متاحة في HTML
  window.checkInChallenge = (id) => {
    const index = challenges.findIndex(c => c.id === id);
    if (index === -1) return;
    
    const ch = challenges[index];
    ch.currentDay++;
    ch.lastCheckIn = new Date().toISOString(); // حفظ تاريخ اليوم
    
    if (ch.currentDay >= ch.totalDays) {
      // تم الانتهاء
      userPoints += parseInt(ch.pointsReward);
      showNotification("أحسنت يا بطل", `أتممت تحدي "${ch.title}" وحصلت على ${ch.pointsReward} نقطة!`);
      showStatusMessage(`مبروك! حصلت على ${ch.pointsReward} نقطة`, 'success');
      // حذف التحدي
      challenges.splice(index, 1);
    }
    
    saveChallengeData();
    renderChallenges();
  };

  window.resetChallenge = (id) => {
    const index = challenges.findIndex(c => c.id === id);
    if (index === -1) return;
    
    showConfirmation("هل تريد الاستسلام وإعادة التحدي من البداية ؟", () => {
      challenges[index].currentDay = 0;
      challenges[index].lastCheckIn = null;
      saveChallengeData();
      renderChallenges();
    });
  };

  openChallengeModalBtn.addEventListener('click', () => {
    addChallengeModal.style.display = 'flex';
  });
  
  closeChallengeModalBtn.addEventListener('click', () => {
    addChallengeModal.style.display = 'none';
  });
  
  saveChallengeBtn.addEventListener('click', () => {
    const title = titleInput.value.trim();
    const duration = parseInt(durationInput.value);
    const points = parseInt(pointsInput.value);
    
    if (title && duration > 0 && points > 0) {
      // (جديد) التحقق من الحد الأقصى للنقاط (20 نقطة لكل يوم)
      const maxAllowedPoints = duration * 20;
      if (points > maxAllowedPoints) {
        showStatusMessage(`عفواً، أقصى نقاط مسموحة لمدة ${duration} يوم هي ${maxAllowedPoints} نقطة.`, 'error');
        return;
      }

      const newChallenge = {
        id: crypto.randomUUID(),
        title: title,
        totalDays: duration,
        currentDay: 0,
        pointsReward: points,
        lastCheckIn: null // لم يبدأ بعد
      };
      challenges.push(newChallenge);
      saveChallengeData();
      addChallengeModal.style.display = 'none';
      
      // تصفير الحقول
      titleInput.value = '';
      durationInput.value = '7';
      pointsInput.value = '50';
    } else {
        showStatusMessage('الرجاء ملء جميع الحقول بشكل صحيح.', 'error');
    }
  });


  // --- 12. دالة التشغيل الرئيسية ---
  function initializeApp() {
    loadTheme();
    
    // المهام
    setupDates();
    loadTasks();
    changeSelectedDay(new Date(dateKeys.today + 'T12:00:00'));
    
    // (جديد) الملاحظات
    loadProfessionalNotes();
    renderNotesList();
    
    // التحفيز
    showDailyMotivation();
    
    // القرآن
    fetchReciterList();
    fetchSurahList();
    loadBookmark(); 
    
    // المسبحة والأذكار
    loadTasbeehState();
    autoOpenAdhkar();
    
    // الإعدادات والصلاة
    loadSettings();
    fetchPrayerTimes(); 
    
    // المؤقت
    updateTimerDisplay();

    // (جديد) التحديات
    loadChallengeData();

    // التحريك
    createScrollObserver();
  }

  initializeApp();

</script>

</body>
</html>


